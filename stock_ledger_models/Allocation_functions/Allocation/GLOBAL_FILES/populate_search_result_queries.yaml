#############################################################
# Created By - Priyanshu Pandey                             #                
# File Name - calculate.yaml                                #
# Purpose - contains all queries for create screen add button  #
#############################################################
setup_warehouse:
  Q_create_wh_srch_table: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_whs_search_temp(WH NUMERIC(10));"

  Q_chk_wh_srch_table: "SELECT count(1) chk
                          FROM information_schema.tables
                         WHERE table_schema = database()
                           AND LOWER(table_name) = 'alloc_whs_search_temp';"

  Q_ins_wh_srch_tbl: "INSERT INTO alloc_whs_search_temp (wh)
                           VALUES (%s);"

  Q_fetch_wh: "SELECT wh.wh
                 FROM warehouse wh
                WHERE wh.stock_holding_ind = 'Y'
                  AND wh.finisher = 'N'
                  AND wh.redist_wh_ind = 'N'
                  AND wh.replenish_ind = 'Y';"

get_item_locs_from_items_whs:
  Q_style_sku: " SELECT im.diff1 diff_id
                   FROM item_dtl im,
                        item_dtl im1,
                        item_dtl aim
                  WHERE im.item_level = 2
                    AND im.tran_level = 2
                    AND im.status     = 'A'
                    AND im1.item      = im.item_parent
                    AND aim.item      = im.item
                    AND im.item         IN {}; "

  Q_hier3_sku: "SELECT id.item
                   FROM item_dtl id
                  WHERE id.hier1      IN {}
                    AND id.hier2      IN {}
                    AND id.hier3      IN {}
                    AND id.item_level = id.tran_level
                    AND id.status     = 'A';"

  Q_hier2_sku: "SELECT id.item
                  FROM item_dtl id
                 WHERE id.hier1      IN {}
                   AND id.hier2      IN {}
                   AND id.item_level = id.tran_level
                   AND id.status     = 'A';" 
                   
  Q_hier1_sku: "SELECT id.item
                  FROM item_dtl id
                 WHERE id.item_level = id.tran_level
                   AND id.status     = 'A'
                   AND id.hier1      IN {};"
  
  Q_input_item: " SELECT im.item
                    FROM item_dtl im
                   WHERE im.item IN {}
                     AND im.item_level = im.tran_level
                     AND im.status     = 'A'
                  UNION
                  SELECT id.item
                    FROM item_dtl id
                   WHERE id.item_parent IN {}
                     AND id.item_level  = id.tran_level
                     AND id.status      = 'A'
                  UNION
                  SELECT id.item
                    FROM item_dtl id
                   WHERE id.item_grandparent IN {}
                     AND id.item_level       = id.tran_level
                     AND id.status           = 'A'  
                   UNION
                  SELECT DISTINCT pb.pack_no
                    FROM item_dtl im,
                         packitem_breakout pb
                   WHERE im.item_parent IN {}
                     AND im.item_level = im.tran_level
                     AND im.status     = 'A'
                     AND pb.item       = im.item;"  

  Q_tran_sku: " SELECT id.item
                  FROM item_dtl id
                 WHERE id.item       IN {}
                   AND id.item_level = id.tran_level
                   AND id.status     = 'A'
                 UNION
                SELECT DISTINCT pb.pack_no
                  FROM packitem_breakout pb
                 where pb.item IN {};"

  Q_pack_no: " SELECT im.item
                 FROM item_dtl im,
                      packitem pi
                WHERE pi.pack_no IN {}
                  AND pi.pack_no  = im.item
                  AND im.pack_ind = 'Y'
                  AND im.status   = 'A';"                                       

  Q_itemlist_sku: "SELECT DISTINCT id.item
                     FROM item_dtl      id,
                          item_list_dtl ild
                    WHERE ild.item_list_no IN {}
                      AND ild.item         = id.item
                      AND id.item_level    = id.tran_level
                      AND id.status        = 'A';"

  Q_itemlist_style: " SELECT DISTINCT im.item
                        FROM item_dtl      im,
                             item_list_dtl sd
                       WHERE sd.item_list_no  IN {}
                         AND sd.item          = im.item
                         AND im.item_level    = im.tran_level
                         AND im.status        = 'A'
                         AND im.pack_ind      ='Y'
                      UNION
                      SELECT im1.item
                        FROM item_dtl im1
                       WHERE (im1.item_parent, im1.diff1) IN (SELECT DISTINCT im.item_parent,
                                                                     im.diff1 
                                                                FROM item_dtl      im, 
                                                                     item_list_dtl sd
                                                               WHERE sd.item_list_no  IN {}
                                                                 AND sd.item          = im.item)
                      UNION
                      SELECT DISTINCT im.item
                        FROM item_dtl      im,
                             item_list_dtl sd
                       WHERE sd.item_list_no  IN {}
                         AND sd.item          = im.item_parent
                         AND im.item_level    = im.tran_level
                         AND im.status        = 'A'
                      UNION
                      SELECT DISTINCT im.item
                        FROM item_dtl      im,
                             item_list_dtl sd
                       WHERE sd.item_list_no  IN {}
                         AND sd.item          = im.item_grandparent
                         AND im.item_level    = im.tran_level
                         AND im.status        = 'A'
                      UNION
                      SELECT DISTINCT im.item
                        FROM item_dtl      im,
                             item_list_dtl sd
                       WHERE sd.item_list_no  IN {}
                         AND sd.item          = im.item
                         AND im.item_level    = im.tran_level
                         AND im.status        = 'A'
                         AND im.pack_ind      ='N'; "

  Q_supplier_sku: "SELECT DISTINCT id.item
                     FROM item_dtl id,
                          item_sups isp,
                          sups s
                    WHERE s.supplier IN {}
                      AND s.supplier           = isp.item_supp
                      AND isp.item              = id.item
                      AND id.item_level        = id.tran_level
                      AND id.status            = 'A';"

  Q_supp_site_sku: "SELECT DISTINCT id.item
                      FROM item_dtl id,
                           item_sups sd
                     WHERE sd.supplier IN {} /*sup site*/
                       AND sd.item                = id.item
                       AND id.item_level          = id.tran_level
                       AND id.status              = 'A';"

  Q_vpn_sku: "SELECT DISTINCT id.item
                FROM item_dtl id
               WHERE id.item_level = id.tran_level
                 AND id.status = 'A'
                 AND EXISTS(SELECT 1
                              FROM item_sups isup,
                                   item_dtl  id1
                             WHERE isup.item = id1.item 
                               AND isup.primary_supp_ind = 'Y'
                               AND isup.product_num IN {}/*sc_scalars.vpn*/
                               AND id1.item = id.item                  
                               /*and NVL(im1.aggr_diff_id,'$') = NVL(aim.aggr_diff_id,'$')*/);"

  Q_vpn_style: " SELECT DISTINCT im.item
                   FROM item_dtl im
                  WHERE im.item_level = im.tran_level
                    AND im.status     = 'A'
                    AND EXISTS(SELECT 1
                                 FROM item_sups isup,
                                      item_dtl  im1
                                WHERE isup.item = im1.item
                                  AND isup.primary_supp_ind = 'Y'
                                  AND isup.product_num      IN {}
                                  AND im1.item_parent       = im.item_parent
                                  AND im1.diff1             = im.diff1); "

  Q_uda_sku: "SELECT DISTINCT id.item
                FROM user_attr_item uai,
                     item_dtl id
               WHERE uai.item         = id.item
                 AND uai.user_attr_id IN {}
                 AND id.item_level    = id.tran_level
                 AND id.status        = 'A'; "

  Q_uda_style: " SELECT DISTINCT im.item
                   FROM item_dtl im
                  WHERE (im.item_parent, im.diff1) IN (SELECT im.item_parent,
                                                              im.diff1
                                                         FROM user_attr_item uil,
                                                              item_dtl       im
                                                        WHERE uil.item         = im.item
                                                          AND uil.user_attr_id IN {}
                                                          AND im.item_level    = im.tran_level
                                                          AND im.status        = 'A'); " 

  Q_excl_uda_sku: "SELECT DISTINCT id.item
                     FROM user_attr_item uai,
                          item_dtl id
                    WHERE uai.item         = id.item
                      AND uai.user_attr_id IN {}
                      AND id.item_level    = id.tran_level
                      AND id.status        = 'A'; "

  Q_uda_val_sku: "SELECT DISTINCT id.item
                    FROM user_attr_item uai,
                         item_dtl id
                   WHERE uai.item            = id.item
                     AND uai.user_attr_id    IN {}
                     AND uai.user_attr_value IN {}
                     AND id.item_level       = id.tran_level
                     AND id.status           = 'A';"

  Q_uda_val_style: " SELECT DISTINCT im.item
                       FROM item_dtl im
                      WHERE (im.item_parent, im.diff1) IN (SELECT item_parent,
                                                                  diff1
                                                             FROM user_attr_item uil,
                                                                  item_dtl       im
                                                            WHERE uil.item            = im.item
                                                              AND uil.user_attr_id    IN {}
                                                              AND uil.user_attr_value IN {}
                                                              AND im.item_level       = im.tran_level
                                                              AND im.status           = 'A');"

  Q_excl_uda_val: "SELECT DISTINCT id.item
                     FROM user_attr_item uai,
                          item_dtl id
                    WHERE uai.item            = id.item
                      AND uai.user_attr_id    IN {}
                      AND uai.user_attr_value IN {}
                      AND id.item_level       = id.tran_level
                      AND id.status           = 'A';"

  Q_create_item_loc_srch_table: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp(ITEM                VARCHAR(25) ,
                                                                                                     LOCATION            NUMERIC(15) ,
                                                                                                     ROLLUP_TYPE         VARCHAR(25) ,
                                                                                                     ROLLUP_ITEM         VARCHAR(25) ,
                                                                                                     ROLLUP_ITEM_DESC    VARCHAR(250) ,
                                                                                                     MULTI_COLOR_PCK_IND VARCHAR(1));"


  Q_chk_item_loc_srch_table: "SELECT count(1) chk
                                FROM information_schema.tables
                               WHERE table_schema = database()
                                 AND table_name = 'alloc_search_criteria_itm_temp';"

  #changes by shubham start#
  # Q_ins_search_item_loc: "INSERT INTO alloc_search_criteria_itm_temp(ITEM,LOCATION)
                                            # VALUES(%s,%s);"

  Q_ins_search_item_loc: "INSERT INTO alloc_search_criteria_itm_temp(ITEM,LOCATION)
                                          SELECT i.item,w.wh
                                            FROM alloc_items_srch_temp i,
                                                 alloc_whs_search_temp w;"                                            
  #changes by shubham end#

  Q_fetch_item_loc_srch: "SELECT i.item,w.wh
                            FROM alloc_items_srch_temp i,
                                 alloc_whs_search_temp w;"

  Q_create_item_srch_table: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_items_srch_temp(ITEM                 VARCHAR(25),
                                                                                        LOCATION             NUMERIC(10),
                                                                                        ROLLUP_TYPE          VARCHAR(20),
                                                                                        ROLLUP_ITEM          VARCHAR(25),
                                                                                        ROLLUP_ITEM_DESC     VARCHAR(250) ,
                                                                                        MULTI_COLOR_PACK_IND VARCHAR(1) ,
                                                                                        COLOR_DIFF_ID        VARCHAR(15) ,
                                                                                        SELLING_UOM          VARCHAR(5) ,
                                                                                        INVENT_IND           VARCHAR(1) ,
                                                                                        HIER1                NUMERIC(4) ,
                                                                                        HIER2                NUMERIC(4) ,
                                                                                        HIER3                NUMERIC(4));"


  Q_chk_item_srch_table: "SELECT count(1) chk
                            FROM information_schema.tables
                           WHERE table_schema = database()
                             AND table_name = 'alloc_items_srch_temp';"

  Q_ins_search_item: "INSERT INTO alloc_items_srch_temp (ITEM)
                                            VALUES(%s);"

get_item_locs_from_txns_whs:
  Q_create_item_loc_srch_table1: " CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp1(ITEM                VARCHAR(25) ,
                                                                                                       LOCATION            NUMERIC(15) ,
                                                                                                       ROLLUP_TYPE         VARCHAR(25) ,
                                                                                                       ROLLUP_ITEM         VARCHAR(25) ,
                                                                                                       ROLLUP_ITEM_DESC    VARCHAR(250),
                                                                                                       MULTI_COLOR_PCK_IND VARCHAR(1)); "

  Q_chk_item_loc_srch_table1: " SELECT count(1) chk
                                  FROM information_schema.tables
                                 WHERE table_schema = database()
                                   AND table_name = 'alloc_search_criteria_itm_temp1'; "

  Q_pos: " SELECT DISTINCT ol.item item,
                  ol.location location
             FROM po_item_loc ol,
                  alloc_whs_search_temp w
            WHERE ol.po_no          IN {}
              AND ol.location_type  = 'W'
              AND w.wh              = ol.location; "

  Q_tsfs: " SELECT DISTINCT
                   td.item        item,
                   th.to_location location
              FROM tsf_dtl th,
                   tsf_item_loc td,
                   alloc_whs_search_temp w
             WHERE th.tsf_id           IN {}
               AND th.to_location_type = 'W'
               AND th.tsf_id           = td.tsf_id
               AND w.wh                = th.to_location; "

  Q_asns: " SELECT DISTINCT
                   ss.item     item,
                   ol.location location
              FROM ship_dtl sh,
                   ship_item ss,
                   po_item_loc ol,
                   warehouse wh,
                   alloc_whs_search_temp w
             WHERE sh.asn_id           IN {}
               AND sh.to_location_type = 'W'
               AND sh.ship_id     = ss.shipment
               AND sh.po_no       = ol.po_no
               AND ss.item        = ol.item
               AND ol.location    = w.wh
               AND ol.location    = wh.wh
               AND wh.physical_wh = sh.to_location; "

  Q_ins_item_loc : " INSERT INTO alloc_search_criteria_itm_temp1(ITEM,LOCATION)
                                 VALUES (%s,%s); "

  Q_del_item_loc_data1 : " DELETE FROM alloc_search_criteria_itm_temp1 tmp1
                                 WHERE tmp1.item NOT IN (SELECT tmp.item FROM alloc_search_criteria_itm_temp tmp); "

  Q_del_item_loc_data : " DELETE FROM alloc_search_criteria_itm_temp; "

  Q_ins_item_loc_data : " INSERT INTO alloc_search_criteria_itm_temp(item,
                                                                     location)
                                                              SELECT item,
                                                                     location
                                                                FROM alloc_search_criteria_itm_temp1; "

  Q_create_srch_temp_1: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp_1 SELECT * FROM alloc_search_criteria_itm_temp;"
  
  Q_create_srch_temp_2: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp_2 SELECT * FROM alloc_search_criteria_itm_temp;"

  Q_merge_pack_criteria_temp: "INSERT INTO alloc_search_criteria_itm_temp (item, location)
                                        SELECT DISTINCT pb.item, gtt.location
                                                   FROM alloc_search_criteria_itm_temp_1 gtt,
                                                        packitem_breakout pb 
                                                  WHERE gtt.item = pb.pack_no
                                         AND NOT EXISTS (
                                                       SELECT 1
                                                       FROM alloc_search_criteria_itm_temp_2 target
                                                       WHERE target.item = pb.item AND target.location = gtt.location);"
                                                        
  Q_drop_criteria_temp_1: "DROP TEMPORARY TABLE alloc_search_criteria_itm_temp_1;"
  Q_drop_criteria_temp_2: "DROP TEMPORARY TABLE alloc_search_criteria_itm_temp_2;"

  Q_sel_item_loc : " SELECT * FROM alloc_search_criteria_itm_temp; "

get_po_source_inv:

  Q_crte_tbl_po_no  : " CREATE TEMPORARY TABLE IF NOT EXISTS alloc_srch_po_no(ref_1  VARCHAR(50)); "

  Q_ins_srch_po_no  : " INSERT INTO alloc_srch_po_no(ref_1) VALUES ('{}'); "

  Q_fetch_srch_po_no: " SELECT * FROM alloc_srch_po_no; "

  Q_del_srch_po_no  : " DELETE FROM alloc_itm_search_dtl_temp 
                              WHERE ref_1 NOT IN (SELECT ref_1 FROM alloc_srch_po_no); "

  Q_del_srch_asn_no  : " DELETE FROM alloc_itm_search_dtl_temp 
                               WHERE SUBSTR(ref_2,INSTR(ref_2,'/')+1,INSTR(SUBSTR(ref_2,INSTR(ref_2,'/')+1),'/')-1) NOT IN (SELECT ref_1 FROM alloc_srch_po_no); "

  Q_crte_tbl_po_type: " CREATE TEMPORARY TABLE IF NOT EXISTS alloc_potype_search_tmp(SEARCH_TYPE  VARCHAR(50),
                                                                                     VALUE1          NUMERIC(50),
                                                                                     VALUE2          NUMERIC(50),
                                                                                     VALUE3          NUMERIC(50)); "

  Q_ins_srch_po_type: " INSERT INTO alloc_potype_search_tmp(SEARCH_TYPE,VALUE1,VALUE2)
                                                     VALUES(CONCAT('PO_TYPE-',%s),NULL,NULL); "

  Q_ins_wi_item_loc: " INSERT INTO alloc_search_criteria_itm_temp(item,
                                                                 location)
                                                          SELECT item,
                                                                 location
                                                            FROM po_item_loc
                                                           WHERE po_no = %s; "

  Q_ins_item_search: "INSERT INTO alloc_items_srch_temp(item,
                                                        location,
                                                        rollup_type,
                                                        rollup_item,
                                                        rollup_item_desc,
                                                        multi_color_pack_ind,
                                                        color_diff_id,
                                                        selling_uom,
                                                        invent_ind,
                                                        hier1,
                                                        hier2,
                                                        hier3)
                                                 SELECT gtt.item,
                                                        gtt.location,                    
                                                        CASE WHEN im.pack_ind = 'Y' THEN 'PACK' ELSE 'STYLE' END rollup_type, 
                                                        im.item         rollup_item,
                                                        im.item_desc    rollup_item_desc,
                                                        NULL             multi_color_pack_ind,
                                                        im.diff1,
                                                        im.selling_uom,
                                                        NULL invent_ind,
                                                        im.hier1,
                                                        im.hier2,
                                                        im.hier3
                                                   FROM alloc_search_criteria_itm_temp  gtt,
                                                        item_dtl                        im
                                                  WHERE im.item = gtt.item
                                                    AND im.item_level = im.tran_level 
                                                    AND im.status = 'A'; "

  Q_ins_style_item_srch: "INSERT INTO alloc_items_srch_temp(item,
                                                            location,
                                                            rollup_type,
                                                            rollup_item,
                                                            rollup_item_desc,
                                                            multi_color_pack_ind,
                                                            color_diff_id,
                                                            selling_uom,
                                                            invent_ind,
                                                            hier1,
                                                            hier2,
                                                            hier3)
                                                     SELECT gtt.item,
                                                            gtt.location,                    
                                                            'STYLE' rollup_type, 
                                                            im.item_parent         rollup_item,
                                                            (SELECT imp.item_desc
                                                               FROM item_dtl imp
                                                              WHERE imp.item = im.item_parent) rollup_item_desc,
                                                            NULL             multi_color_pack_ind,
                                                            im.diff1,
                                                            im.selling_uom,
                                                            NULL invent_ind,
                                                            im.hier1,
                                                            im.hier2,
                                                            im.hier3
                                                       FROM alloc_search_criteria_itm_temp  gtt,
                                                            item_dtl                        im
                                                      WHERE im.item = gtt.item
                                                        AND im.item_level = im.tran_level
                                                        AND im.tran_level = 2    
                                                        AND im.status = 'A'; "

  Q_ins_item_srch_wia: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                               alloc_no,
                                                               alloc_criteria,
                                                               item,
                                                               item_desc,
                                                               diff_id,
                                                               loc,
                                                               hier1,
                                                               hier2,
                                                               hier3,
                                                               pack_ind,
                                                               inner_size,
                                                               case_size,
                                                               avail_qty,
                                                               inactive_qty,
                                                               holdback_qty,
                                                               holdback_type,
                                                               alloc_type,
                                                               size_prf_ind,
                                                               substitute_ind,
                                                               clearance_ind,
                                                               invent_ind,
                                                               split_ind,
                                                               som_type,
                                                               som_qty,
                                                               vpn,
                                                               season,
                                                               ref_1,
                                                               ref_2,
                                                               po_type,
                                                               err_ind,
                                                               err_message,
                                                               create_id,
                                                               create_datetime,
                                                               last_update_id,
                                                               last_update_datetime)
                                                        SELECT 'N' sel_ind,
                                                                %s alloc_no,
                                                                doc_type alloc_criteria,
                                                                item,
                                                                item_desc,
                                                                diff_id,   
                                                                loc,
                                                                hier1,
                                                                hier2,
                                                                hier3,
                                                                pack_ind,
                                                                inner_size,
                                                                case_size,
                                                                available_qty,
                                                                inactive_qty,
                                                                NULL holdback_qty,
                                                                NULL holdback_type,
                                                                % alloc_type,
                                                                COALESCE((SELECT MAX('Y')
                                                                         FROM alloc_size_profile sp
                                                                        WHERE sp.item_parent = i.item
                                                                          AND sp.aggr_diff_id = i.diff_id
                                                                          AND sp.status = 'A'
                                                                          AND estimated_instock_date <= sp.end_date
                                                                          AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                   THEN curdate()
                                                                                                                   ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                    END v_date) and estimated_instock_date
                                                                          AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                           THEN curdate()
                                                                                           ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                            END v_date) <= sp.create_datetime
                                                                          LIMIT 1),'N') size_prf_ind,
                                                                substitute_ind,
                                                                clearance_ind,
                                                                invent_ind,
                                                                'N' split_ind,
                                                                calc_multiple som_type,
                                                                som_qty,
                                                                UPPER(COALESCE(null,vpn)) vpn,
                                                                (SELECT user_attr_value
                                                                FROM user_attr_item
                                                                 WHERE user_attr_id = 41
                                                                 AND user_attr_value=season_code) season,
                                                                doc_id ref_1,
                                                                CONCAT(doc_id,'/',not_before_date) ref_1,
                                                                po_type,
                                                                NULL err_ind,
                                                                NULL err_message,
                                                                USER() create_id,
                                                                CURDATE() create_datetime,
                                                                USER() last_update_id,
                                                                CURRENT_TIMESTAMP() last_update_datetime
                                                           FROM (SELECT gtt.item            item,
                                                                (SELECT im.item_desc
                                                                   FROM item_dtl im
                                                                  WHERE im.item = gtt.item) item_desc,
                                                                gtt.color_diff_id           diff_id,
                                                                gtt.location   loc,
                                                                MAX(gtt.hier1) hier1,
                                                                MAX(gtt.hier2) hier2,
                                                                MAX(gtt.hier3) hier3,
                                                                0 holdback_qty,
                                                                NULL            holdback_qty_type,
                                                                MAX(oh.po_type) po_type,
                                                                MAX(DATE(ol.instock_date))     estimated_instock_date,
                                                                MAX(DATE (oh.not_before_date)) not_before_date,
                                                                SUM((CASE WHEN ilc.status in ('A','C') THEN ol.ordered_qty ELSE 0 END)
                                                                     - COALESCE((CASE WHEN ilc.status in ('A','C') THEN ol.received_qty ELSE 0 END), 0)
                                                                     - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                   FROM alloc_sku_head alh,
                                                                                        alloc_dtl     ald,
                                                                                        alloc_xref    alx,
                                                                                        item_location ilc1
                                                                                  WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                    AND ald.alloc_no = alh.alloc_no
                                                                                    AND alh.item = gtt.item
                                                                                    AND alh.order_no = oh.po_no
                                                                                    AND alh.wh = gtt.location
                                                                                    AND ilc1.location = gtt.location
                                                                                    AND ilc1.item = gtt.item
                                                                                    AND ilc1.status in ('A','C')
                                                                               GROUP BY alh.item, alh.order_no),0)) available_qty,
                                                                SUM((CASE WHEN ilc.status in ('I') THEN ol.ordered_qty ELSE 0 END)
                                                                     - COALESCE((CASE WHEN ilc.status in ('I') THEN ol.received_qty ELSE 0 END), 0)
                                                                     - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                   FROM alloc_sku_head alh,
                                                                                        alloc_dtl     ald,
                                                                                        alloc_xref    alx,
                                                                                        item_location ilc1
                                                                                  WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                    AND ald.alloc_no = alh.alloc_no
                                                                                    AND alh.item = gtt.item
                                                                                    AND alh.order_no = oh.po_no
                                                                                    AND alh.wh = gtt.location
                                                                                    AND ilc1.location = gtt.location
                                                                                    AND ilc1.item = gtt.item
                                                                                    AND ilc1.status in ('I')
                                                                               GROUP BY alh.item, alh.order_no),0)) inactive_qty,
                                                                oh.po_no doc_id,
                                                                'P' doc_type,
                                                                'N' size_profile_ind,
                                                                MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                MAX(ilc.clearance_ind) clearance_ind,
                                                                MAX(gtt.invent_ind) invent_ind,
                                                                (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                MAX(isc.inner_pack_size) inner_size,
                                                                MAX(isc.supp_pack_size) case_size,
                                                                MAX(gtt.selling_uom) calc_multiple,
                                                                MAX(CASE
                                                                     WHEN gtt.selling_uom = 'I'
                                                                     THEN isc.inner_pack_size
                                                                     WHEN gtt.selling_uom = 'C'
                                                                     THEN isc.supp_pack_size
                                                                     ELSE 1
                                                                    END) som_qty,
                                                                MAX(isp.product_num) vpn,
                                                                MAX(uil.user_attr_value) season_code
                                                           FROM alloc_items_srch_temp gtt
                                                      LEFT JOIN subs_item_dtl si 
                                                             ON (gtt.item = si.item
                                                             AND gtt.location = si.location)
                                                      LEFT JOIN user_attr_item uil 
                                                             ON (gtt.item = uil.item
                                                            AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                po_item_loc                ol,
                                                                po_dtl                     oh,
                                                                item_location              ilc,
                                                                item_sups                  isp,
                                                                item_sup_location           isc
                                                          WHERE gtt.item = ol.item
                                                            AND gtt.location = ol.location
                                                            AND ol.po_no = oh.po_no
                                                            AND COALESCE(oh.po_type,'$') != COALESCE('ARB','$')
                                                            AND ((oh.po_origin_ind != 0) OR (oh.po_origin_ind = 0))
                                                            AND oh.po_no = %s
                                                            AND gtt.item = ilc.item
                                                            AND gtt.location = ilc.location
                                                            AND ilc.status IN ('A', 'C', 'I')
                                                            AND isp.item = gtt.item
                                                            AND isp.item_supp = oh.supplier_id
                                                            AND isc.item = isp.item
                                                            AND isc.supplier = isp.item_supp
                                                            AND isc.primary_country_ind = 'Y'
                                                       GROUP BY gtt.item,
                                                                oh.po_no,
                                                                gtt.rollup_item,
                                                                gtt.location,
                                                                gtt.color_diff_id,
                                                                (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i; "

  Q_ins_style_item_srch_wia: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                                     alloc_no,
                                                                     alloc_criteria,
                                                                     item,
                                                                     item_desc,
                                                                     diff_id,
                                                                     loc,
                                                                     hier1,
                                                                     hier2,
                                                                     hier3,
                                                                     pack_ind,
                                                                     inner_size,
                                                                     case_size,
                                                                     avail_qty,
                                                                     inactive_qty,
                                                                     holdback_qty,
                                                                     holdback_type,
                                                                     alloc_type,
                                                                     size_prf_ind,
                                                                     substitute_ind,
                                                                     clearance_ind,
                                                                     invent_ind,
                                                                     split_ind,
                                                                     som_type,
                                                                     som_qty,
                                                                     vpn,
                                                                     season,
                                                                     ref_1,
                                                                     ref_2,
                                                                     po_type,
                                                                     err_ind,
                                                                     err_message,
                                                                     create_id,
                                                                     create_datetime,
                                                                     last_update_id,
                                                                     last_update_datetime)
                                                              SELECT 'N' sel_ind,
                                                                      %s alloc_no,
                                                                      doc_type alloc_criteria,
                                                                      item,
                                                                      item_desc,
                                                                      diff_id,   
                                                                      loc,
                                                                      hier1,
                                                                      hier2,
                                                                      hier3,
                                                                      pack_ind,
                                                                      inner_size,
                                                                      case_size,
                                                                      available_qty,
                                                                      inactive_qty,
                                                                      NULL holdback_qty,
                                                                      NULL holdback_type,
                                                                      % alloc_type,
                                                                      COALESCE((SELECT MAX('Y')
                                                                               FROM alloc_size_profile sp
                                                                              WHERE sp.item_parent = i.item
                                                                                AND sp.aggr_diff_id = i.diff_id
                                                                                AND sp.status = 'A'
                                                                                AND estimated_instock_date <= sp.end_date
                                                                                AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                         THEN curdate()
                                                                                                                         ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                          END v_date) and estimated_instock_date
                                                                                AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                 THEN curdate()
                                                                                                 ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                  END v_date) <= sp.create_datetime
                                                                                LIMIT 1),'N') size_prf_ind,
                                                                      substitute_ind,
                                                                      clearance_ind,
                                                                      invent_ind,
                                                                      'N' split_ind,
                                                                      calc_multiple som_type,
                                                                      som_qty,
                                                                      UPPER(COALESCE(null,vpn)) vpn,
                                                                      (SELECT user_attr_value
                                                                      FROM user_attr_item
                                                                       WHERE user_attr_id = 41
                                                                       AND user_attr_value=season_code) season,
                                                                      doc_id ref_1,
                                                                      CONCAT(doc_id,'/',not_before_date) ref_1,
                                                                      po_type,
                                                                      NULL err_ind,
                                                                      NULL err_message,
                                                                      USER() create_id,
                                                                      CURDATE() create_datetime,
                                                                      USER() last_update_id,
                                                                      CURRENT_TIMESTAMP() last_update_datetime
                                                                 FROM (SELECT gtt.rollup_item     item,
                                                                      MAX (gtt.rollup_item_desc)  item_desc,
                                                                      gtt.color_diff_id           diff_id,
                                                                      gtt.location   loc,
                                                                      MAX(gtt.hier1) hier1,
                                                                      MAX(gtt.hier2) hier2,
                                                                      MAX(gtt.hier3) hier3,
                                                                      0 holdback_qty,
                                                                      NULL            holdback_qty_type,
                                                                      MAX(oh.po_type) po_type,
                                                                      MAX(DATE(ol.instock_date))     estimated_instock_date,
                                                                      MAX(DATE (oh.not_before_date)) not_before_date,
                                                                      SUM((CASE WHEN ilc.status in ('A','C') THEN ol.ordered_qty ELSE 0 END)
                                                                           - COALESCE((CASE WHEN ilc.status in ('A','C') THEN ol.received_qty ELSE 0 END), 0)
                                                                           - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                         FROM alloc_sku_head alh,
                                                                                              alloc_dtl     ald,
                                                                                              alloc_xref    alx,
                                                                                              item_location ilc1
                                                                                        WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                          AND ald.alloc_no = alh.alloc_no
                                                                                          AND alh.item = gtt.item
                                                                                          AND alh.order_no = oh.po_no
                                                                                          AND alh.wh = gtt.location
                                                                                          AND ilc1.location = gtt.location
                                                                                          AND ilc1.item = gtt.item
                                                                                          AND ilc1.status in ('A','C')
                                                                                     GROUP BY alh.item, alh.order_no),0)) available_qty,
                                                                      SUM((CASE WHEN ilc.status in ('I') THEN ol.ordered_qty ELSE 0 END)
                                                                           - COALESCE((CASE WHEN ilc.status in ('I') THEN ol.received_qty ELSE 0 END), 0)
                                                                           - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                         FROM alloc_sku_head alh,
                                                                                              alloc_dtl     ald,
                                                                                              alloc_xref    alx,
                                                                                              item_location ilc1
                                                                                        WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                          AND ald.alloc_no = alh.alloc_no
                                                                                          AND alh.item = gtt.item
                                                                                          AND alh.order_no = oh.po_no
                                                                                          AND alh.wh = gtt.location
                                                                                          AND ilc1.location = gtt.location
                                                                                          AND ilc1.item = gtt.item
                                                                                          AND ilc1.status in ('I')
                                                                                     GROUP BY alh.item, alh.order_no),0)) inactive_qty,
                                                                      oh.po_no doc_id,
                                                                      'P' doc_type,
                                                                      'N' size_profile_ind,
                                                                      MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                      MAX(ilc.clearance_ind) clearance_ind,
                                                                      MAX(gtt.invent_ind) invent_ind,
                                                                      (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                      MAX(isc.inner_pack_size) inner_size,
                                                                      MAX(isc.supp_pack_size) case_size,
                                                                      MAX(gtt.selling_uom) calc_multiple,
                                                                      MAX(CASE
                                                                           WHEN gtt.selling_uom = 'I'
                                                                           THEN isc.inner_pack_size
                                                                           WHEN gtt.selling_uom = 'C'
                                                                           THEN isc.supp_pack_size
                                                                           ELSE 1
                                                                          END) som_qty,
                                                                      MAX(isp.product_num) vpn,
                                                                      MAX(uil.user_attr_value) season_code
                                                                 FROM alloc_items_srch_temp gtt
                                                            LEFT JOIN subs_item_dtl si 
                                                                   ON (gtt.item = si.item
                                                                   AND gtt.location = si.location)
                                                            LEFT JOIN user_attr_item uil 
                                                                   ON (gtt.item = uil.item
                                                                  AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                      po_item_loc                ol,
                                                                      po_dtl                     oh,
                                                                      item_location              ilc,
                                                                      item_sups                  isp,
                                                                      item_sup_country           isc
                                                                WHERE gtt.item = ol.item
                                                                  AND gtt.location = ol.location
                                                                  AND ol.po_no = oh.po_no
                                                                  AND COALESCE(oh.po_type,'$') != COALESCE('ARB','$')
                                                                  AND ((oh.po_origin_ind != 0) OR (oh.po_origin_ind = 0))
                                                                  AND oh.po_no = %s
                                                                  AND gtt.item = ilc.item
                                                                  AND gtt.location = ilc.location
                                                                  AND ilc.status IN ('A', 'C', 'I')
                                                                  AND isp.item = gtt.item
                                                                  AND isp.item_supp = oh.supplier_id
                                                                  AND isc.item = isp.item
                                                                  AND isc.supplier = isp.item_supp
                                                                  AND isc.primary_country_ind = 'Y'
                                                             GROUP BY rollup_item
                                                                      oh.po_no,
                                                                      gtt.location,
                                                                      gtt.color_diff_id,
                                                                      (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i; "

  Q_ins_item_srch_pos: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                               alloc_no,
                                                               alloc_criteria,
                                                               item,
                                                               item_desc,
                                                               diff_id,
                                                               loc,
                                                               hier1,
                                                               hier2,
                                                               hier3,
                                                               pack_ind,
                                                               inner_size,
                                                               case_size,
                                                               avail_qty,
                                                               inactive_qty,
                                                               holdback_qty,
                                                               holdback_type,
                                                               alloc_type,
                                                               size_prf_ind,
                                                               substitute_ind,
                                                               clearance_ind,
                                                               invent_ind,
                                                               split_ind,
                                                               som_type,
                                                               som_qty,
                                                               vpn,
                                                               season,
                                                               ref_1,
                                                               ref_2,
                                                               po_type,
                                                               err_ind,
                                                               err_message,
                                                               create_id,
                                                               create_datetime,
                                                               last_update_id,
                                                               last_update_datetime)
                                                        SELECT 'N' sel_ind,
                                                                %s alloc_no,
                                                                doc_type alloc_criteria,
                                                                item,
                                                                item_desc,
                                                                diff_id,   
                                                                loc,
                                                                hier1,
                                                                hier2,
                                                                hier3,
                                                                pack_ind,
                                                                inner_size,
                                                                case_size,
                                                                available_qty,
                                                                inactive_qty,
                                                                NULL holdback_qty,
                                                                NULL holdback_type,
                                                                %s alloc_type,
                                                                COALESCE((SELECT MAX('Y')
                                                                         FROM alloc_size_profile sp
                                                                        WHERE sp.item_parent = i.item
                                                                          AND sp.aggr_diff_id = i.diff_id
                                                                          AND sp.status = 'A'
                                                                          AND estimated_instock_date <= sp.end_date
                                                                          AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                   THEN curdate()
                                                                                                                   ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                    END v_date) and estimated_instock_date
                                                                          AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                           THEN curdate()
                                                                                           ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                            END v_date) <= sp.create_datetime
                                                                          LIMIT 1),'N') size_prf_ind,
                                                                substitute_ind,
                                                                clearance_ind,
                                                                invent_ind,
                                                                'N' split_ind,
                                                                calc_multiple som_type,
                                                                som_qty,
                                                                UPPER(vpn) vpn,
                                                                (SELECT user_attr_value
                                                                   FROM user_attr_item
                                                                  WHERE user_attr_id = 41
                                                                    AND user_attr_value=season_code) season,
                                                                doc_id ref_1,
                                                                CONCAT(doc_id,'/',not_before_date) ref_2,
                                                                po_type,
                                                                NULL err_ind,
                                                                NULL err_message,
                                                                USER() create_id,
                                                                CURDATE() create_datetime,
                                                                USER() last_update_id,
                                                                CURRENT_TIMESTAMP() last_update_datetime
                                                           FROM (SELECT gtt.item            item,
                                                                (SELECT im.item_desc
                                                                   FROM item_dtl im
                                                                  WHERE im.item = gtt.item) item_desc,
                                                                gtt.color_diff_id           diff_id,
                                                                gtt.location   loc,
                                                                MAX(gtt.hier1) hier1,
                                                                MAX(gtt.hier2) hier2,
                                                                MAX(gtt.hier3) hier3,
                                                                0 holdback_qty,
                                                                NULL            holdback_qty_type,
                                                                MAX(oh.po_type) po_type,
                                                                MAX(DATE(ol.instock_date))     estimated_instock_date,
                                                                MAX(DATE (oh.not_before_date)) not_before_date,
                                                                SUM((CASE WHEN ilc.status in ('A','C') THEN ol.ordered_qty ELSE 0 END)
                                                                     - COALESCE((CASE WHEN ilc.status in ('A','C') THEN ol.received_qty ELSE 0 END), 0)
                                                                     - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                   FROM alloc_sku_head alh,
                                                                                        alloc_dtl     ald,
                                                                                        alloc_xref    alx,
                                                                                        item_location ilc1
                                                                                  WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                    AND ald.alloc_no = alh.alloc_no
                                                                                    AND alh.item = gtt.item
                                                                                    AND alh.order_no = oh.po_no
                                                                                    AND alh.wh = gtt.location
                                                                                    AND ilc1.location = gtt.location
                                                                                    AND ilc1.item = gtt.item
                                                                                    AND ilc1.status in ('A','C')
                                                                               GROUP BY alh.item, alh.order_no),0)) available_qty,
                                                                SUM((CASE WHEN ilc.status in ('I') THEN ol.ordered_qty ELSE 0 END)
                                                                     - COALESCE((CASE WHEN ilc.status in ('I') THEN ol.received_qty ELSE 0 END), 0)
                                                                     - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                   FROM alloc_sku_head alh,
                                                                                        alloc_dtl     ald,
                                                                                        alloc_xref    alx,
                                                                                        item_location ilc1
                                                                                  WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                    AND ald.alloc_no = alh.alloc_no
                                                                                    AND alh.item = gtt.item
                                                                                    AND alh.order_no = oh.po_no
                                                                                    AND alh.wh = gtt.location
                                                                                    AND ilc1.location = gtt.location
                                                                                    AND ilc1.item = gtt.item
                                                                                    AND ilc1.status in ('I')
                                                                               GROUP BY alh.item, alh.order_no),0)) inactive_qty,
                                                                oh.po_no doc_id,
                                                                'P' doc_type,
                                                                'N' size_profile_ind,
                                                                MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                MAX(ilc.clearance_ind) clearance_ind,
                                                                MAX(gtt.invent_ind) invent_ind,
                                                                (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                MAX(isc.inner_pack_size) inner_size,
                                                                MAX(isc.supp_pack_size) case_size,
                                                                MAX(gtt.selling_uom) calc_multiple,
                                                                MAX(CASE
                                                                     WHEN gtt.selling_uom = 'I'
                                                                     THEN isc.inner_pack_size
                                                                     WHEN gtt.selling_uom = 'C'
                                                                     THEN isc.supp_pack_size
                                                                     ELSE 1
                                                                    END) som_qty,
                                                                MAX(isp.product_num) vpn,
                                                                MAX(uil.user_attr_value) season_code
                                                           FROM alloc_items_srch_temp gtt
                                                      LEFT JOIN subs_item_dtl si 
                                                             ON (gtt.item = si.item
                                                             AND gtt.location = si.location)
                                                      LEFT JOIN user_attr_item uil 
                                                             ON (gtt.item = uil.item
                                                            AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                po_item_loc                ol,
                                                                po_dtl                     oh
                                                      LEFT JOIN whatif_po_alloc            wip 
                                                            ON (wip.order_no = oh.po_no
                                                            AND CASE WHEN wip.order_no IS NOT NULL 
                                                                     THEN 
                                                                         CASE WHEN oh.status = 'S' THEN 'A' ELSE oh.status END 
                                                                     ELSE oh.status end = 'A'),
                                                                item_location              ilc,
                                                                item_sups                  isp,
                                                                item_sup_location          isc
                                                          WHERE gtt.item = ol.item
                                                            AND gtt.location = ol.location
                                                            AND ol.po_no   = oh.po_no
                                                            AND COALESCE(oh.po_type,'$') != COALESCE('ARB','$')
                                                            AND ((oh.po_origin_ind != 0) OR (oh.po_origin_ind = 0))
                                                            AND COALESCE(DATE(oh.not_before_date),COALESCE(%s,CURDATE())) >= COALESCE(%s,COALESCE(DATE(oh.not_before_date),CURDATE()))
                                                            AND COALESCE(DATE(oh.not_before_date),COALESCE(%s,CURDATE())) <= COALESCE(%s,COALESCE(DATE(oh.not_before_date),CURDATE()))
                                                            AND COALESCE(oh.po_type,'$') = COALESCE(COALESCE((SELECT SUBSTR(search_type,9)
                                                                                                                FROM alloc_potype_search_tmp
                                                                                                               WHERE SUBSTR(search_type,1,8) = 'PO_TYPE-' limit 1),oh.po_type),'$')
                                                            AND COALESCE(DATE(ol.instock_date),COALESCE(%s,CURDATE())) >= COALESCE(%s,COALESCE(DATE(ol.instock_date),CURDATE()))
                                                            AND COALESCE(DATE(ol.instock_date),COALESCE(%s,CURDATE())) <= COALESCE(%s,COALESCE(DATE(ol.instock_date),CURDATE()))
                                                            AND gtt.item     = ilc.item
                                                            AND gtt.location = ilc.location
                                                            AND ilc.status IN ('A', 'C', 'I')
                                                            AND isp.item      = gtt.item
                                                            AND isp.item_supp = oh.supplier_id
                                                            AND isc.item      = isp.item
                                                            AND isc.supplier  = isp.item_supp
                                                            AND isc.primary_country_ind = 'Y'
                                                            AND (ol.ordered_qty
                                                                 - COALESCE(ol.received_qty, 0)
                                                                 - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                               FROM alloc_sku_head alh,
                                                                                    alloc_dtl     ald,
                                                                                    alloc_xref    alx
                                                                              WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                AND ald.alloc_no = alh.alloc_no
                                                                                AND alh.item = gtt.item
                                                                                AND alh.order_no = oh.po_no
                                                                                AND alh.wh = gtt.location
                                                                           GROUP BY alh.item, alh.order_no),0)) >= 1
                                                            AND ilc.clearance_ind = COALESCE(%s,ilc.clearance_ind)
                                                       GROUP BY gtt.item,
                                                                oh.po_no,
                                                                gtt.location,
                                                                gtt.color_diff_id,
                                                                (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i
                                                          WHERE (i.available_qty + i.inactive_qty) >= 1
                                                            AND i.clearance_ind = COALESCE(%s, i.clearance_ind)
                                                            AND (i.available_qty + i.inactive_qty) <= COALESCE(%s, 999999999999); "

  Q_ins_style_item_srch_pos: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                                     alloc_no,
                                                                     alloc_criteria,
                                                                     item,
                                                                     item_desc,
                                                                     diff_id,
                                                                     loc,
                                                                     hier1,
                                                                     hier2,
                                                                     hier3,
                                                                     pack_ind,
                                                                     inner_size,
                                                                     case_size,
                                                                     avail_qty,
                                                                     inactive_qty,
                                                                     holdback_qty,
                                                                     holdback_type,
                                                                     alloc_type,
                                                                     size_prf_ind,
                                                                     substitute_ind,
                                                                     clearance_ind,
                                                                     invent_ind,
                                                                     split_ind,
                                                                     som_type,
                                                                     som_qty,
                                                                     vpn,
                                                                     season,
                                                                     ref_1,
                                                                     ref_2,
                                                                     po_type,
                                                                     err_ind,
                                                                     err_message,
                                                                     create_id,
                                                                     create_datetime,
                                                                     last_update_id,
                                                                     last_update_datetime)
                                                              SELECT 'N' sel_ind,
                                                                      %s alloc_no,
                                                                      doc_type alloc_criteria,
                                                                      item,
                                                                      item_desc,
                                                                      diff_id,   
                                                                      loc,
                                                                      hier1,
                                                                      hier2,
                                                                      hier3,
                                                                      pack_ind,
                                                                      inner_size,
                                                                      case_size,
                                                                      available_qty,
                                                                      inactive_qty,
                                                                      NULL holdback_qty,
                                                                      NULL holdback_type,
                                                                      %s alloc_type,
                                                                      COALESCE((SELECT MAX('Y')
                                                                               FROM alloc_size_profile sp
                                                                              WHERE sp.item_parent = i.item
                                                                                AND sp.aggr_diff_id = i.diff_id
                                                                                AND sp.status = 'A'
                                                                                AND estimated_instock_date <= sp.end_date
                                                                                AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                         THEN curdate()
                                                                                                                         ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                          END v_date) and estimated_instock_date
                                                                                AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                 THEN curdate()
                                                                                                 ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                  END v_date) <= sp.create_datetime
                                                                                LIMIT 1),'N') size_prf_ind,
                                                                      substitute_ind,
                                                                      clearance_ind,
                                                                      invent_ind,
                                                                      'N' split_ind,
                                                                      calc_multiple som_type,
                                                                      som_qty,
                                                                      UPPER(vpn) vpn,
                                                                      (SELECT user_attr_value
                                                                         FROM user_attr_item
                                                                        WHERE user_attr_id = 41
                                                                          AND user_attr_value=season_code) season,
                                                                      doc_id ref_1,
                                                                      CONCAT(doc_id,'/',not_before_date) ref_2,
                                                                      po_type,
                                                                      NULL err_ind,
                                                                      NULL err_message,
                                                                      USER() create_id,
                                                                      CURDATE() create_datetime,
                                                                      USER() last_update_id,
                                                                      CURRENT_TIMESTAMP() last_update_datetime
                                                                 FROM (SELECT gtt.rollup_item     item,
                                                                      MAX(gtt.rollup_item_desc)   item_desc,
                                                                      gtt.color_diff_id           diff_id,
                                                                      gtt.location   loc,
                                                                      MAX(gtt.hier1) hier1,
                                                                      MAX(gtt.hier2) hier2,
                                                                      MAX(gtt.hier3) hier3,
                                                                      0 holdback_qty,
                                                                      NULL            holdback_qty_type,
                                                                      MAX(oh.po_type) po_type,
                                                                      MAX(DATE(ol.instock_date))     estimated_instock_date,
                                                                      MAX(DATE (oh.not_before_date)) not_before_date,
                                                                      SUM((CASE WHEN ilc.status in ('A','C') THEN ol.ordered_qty ELSE 0 END)
                                                                           - COALESCE((CASE WHEN ilc.status in ('A','C') THEN ol.received_qty ELSE 0 END), 0)
                                                                           - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                         FROM alloc_sku_head alh,
                                                                                              alloc_dtl     ald,
                                                                                              alloc_xref    alx,
                                                                                              item_location ilc1
                                                                                        WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                          AND ald.alloc_no = alh.alloc_no
                                                                                          AND alh.item = gtt.item
                                                                                          AND alh.order_no = oh.po_no
                                                                                          AND alh.wh = gtt.location
                                                                                          AND ilc1.location = gtt.location
                                                                                          AND ilc1.item = gtt.item
                                                                                          AND ilc1.status in ('A','C')
                                                                                     GROUP BY alh.item, alh.order_no),0)) available_qty,
                                                                      SUM((CASE WHEN ilc.status in ('I') THEN ol.ordered_qty ELSE 0 END)
                                                                           - COALESCE((CASE WHEN ilc.status in ('I') THEN ol.received_qty ELSE 0 END), 0)
                                                                           - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                         FROM alloc_sku_head alh,
                                                                                              alloc_dtl     ald,
                                                                                              alloc_xref    alx,
                                                                                              item_location ilc1
                                                                                        WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                          AND ald.alloc_no = alh.alloc_no
                                                                                          AND alh.item = gtt.item
                                                                                          AND alh.order_no = oh.po_no
                                                                                          AND alh.wh = gtt.location
                                                                                          AND ilc1.location = gtt.location
                                                                                          AND ilc1.item = gtt.item
                                                                                          AND ilc1.status in ('I')
                                                                                     GROUP BY alh.item, alh.order_no),0)) inactive_qty,
                                                                      oh.po_no doc_id,
                                                                      'P' doc_type,
                                                                      'N' size_profile_ind,
                                                                      MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                      MAX(ilc.clearance_ind) clearance_ind,
                                                                      MAX(gtt.invent_ind) invent_ind,
                                                                      (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                      MAX(isc.inner_pack_size) inner_size,
                                                                      MAX(isc.supp_pack_size) case_size,
                                                                      MAX(gtt.selling_uom) calc_multiple,
                                                                      MAX(CASE
                                                                           WHEN gtt.selling_uom = 'I'
                                                                           THEN isc.inner_pack_size
                                                                           WHEN gtt.selling_uom = 'C'
                                                                           THEN isc.supp_pack_size
                                                                           ELSE 1
                                                                          END) som_qty,
                                                                      MAX(isp.product_num) vpn,
                                                                      MAX(uil.user_attr_value) season_code
                                                                 FROM alloc_items_srch_temp gtt
                                                            LEFT JOIN subs_item_dtl si 
                                                                   ON (gtt.item = si.item
                                                                   AND gtt.location = si.location)
                                                            LEFT JOIN user_attr_item uil 
                                                                   ON (gtt.item = uil.item
                                                                  AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                      po_item_loc                ol,
                                                                      po_dtl                     oh
                                                            LEFT JOIN whatif_po_alloc            wip 
                                                                  ON (wip.order_no = oh.po_no
                                                                  AND CASE WHEN wip.order_no IS NOT NULL 
                                                                           THEN 
                                                                               CASE WHEN oh.status = 'S' THEN 'A' ELSE oh.status END 
                                                                           ELSE oh.status end = 'A'),
                                                                      item_location              ilc,
                                                                      item_sups                  isp,
                                                                      item_sup_location          isc
                                                                WHERE gtt.item = ol.item
                                                                  AND gtt.location = ol.location
                                                                  AND ol.po_no   = oh.po_no
                                                                  AND COALESCE(oh.po_type,'$') != COALESCE('ARB','$')
                                                                  AND ((oh.po_origin_ind != 0) OR (oh.po_origin_ind = 0))
                                                                  AND COALESCE(DATE(oh.not_before_date),COALESCE(%s,CURDATE())) >= COALESCE(%s,COALESCE(DATE(oh.not_before_date),CURDATE()))
                                                                  AND COALESCE(DATE(oh.not_before_date),COALESCE(%s,CURDATE())) <= COALESCE(%s,COALESCE(DATE(oh.not_before_date),CURDATE()))
                                                                  AND COALESCE(oh.po_type,'$') = COALESCE(COALESCE((SELECT SUBSTR(search_type,9)
                                                                                                                      FROM alloc_potype_search_tmp
                                                                                                                     WHERE SUBSTR(search_type,1,8) = 'PO_TYPE-' limit 1),oh.po_type),'$')
                                                                  AND COALESCE(DATE(ol.instock_date),COALESCE(%s,CURDATE())) >= COALESCE(%s,COALESCE(DATE(ol.instock_date),CURDATE()))
                                                                  AND COALESCE(DATE(ol.instock_date),COALESCE(%s,CURDATE())) <= COALESCE(%s,COALESCE(DATE(ol.instock_date),CURDATE()))
                                                                  AND gtt.item     = ilc.item
                                                                  AND gtt.location = ilc.location
                                                                  AND ilc.status IN ('A', 'C', 'I')
                                                                  AND isp.item      = gtt.item
                                                                  AND isp.item_supp = oh.supplier_id
                                                                  AND isc.item      = isp.item
                                                                  AND isc.supplier  = isp.item_supp
                                                                  AND isc.primary_country_ind = 'Y'
                                                                  AND (ol.ordered_qty
                                                                       - COALESCE(ol.received_qty, 0)
                                                                       - COALESCE((SELECT SUM(ald.alloc_qty)
                                                                                     FROM alloc_sku_head alh,
                                                                                          alloc_dtl      ald,
                                                                                          alloc_xref     alx
                                                                                    WHERE alh.alloc_no = alx.xref_alloc_no
                                                                                      AND ald.alloc_no = alh.alloc_no
                                                                                      AND alh.item = gtt.item
                                                                                      AND alh.order_no = oh.po_no
                                                                                      AND alh.wh = gtt.location
                                                                                 GROUP BY alh.item, alh.order_no),0)) >= 1
                                                                  AND ilc.clearance_ind = COALESCE(%s,ilc.clearance_ind)
                                                             GROUP BY gtt.rollup_item,
                                                                      oh.po_no,
                                                                      gtt.location,
                                                                      gtt.color_diff_id,
                                                                      (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i
                                                                WHERE (i.available_qty + i.inactive_qty) >= 1
                                                                  AND i.clearance_ind = COALESCE(%s, i.clearance_ind)
                                                                  AND (i.available_qty + i.inactive_qty) <= COALESCE(%s, 999999999999); "

get_tsf_source_inv:
  Q_ins_item_srch_tsf: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                               alloc_no,
                                                               alloc_criteria,
                                                               item,
                                                               item_desc,
                                                               diff_id,
                                                               loc,
                                                               hier1,
                                                               hier2,
                                                               hier3,
                                                               pack_ind,
                                                               inner_size,
                                                               case_size,
                                                               avail_qty,
                                                               inactive_qty,
                                                               holdback_qty,
                                                               holdback_type,
                                                               alloc_type,
                                                               size_prf_ind,
                                                               substitute_ind,
                                                               clearance_ind,
                                                               invent_ind,
                                                               split_ind,
                                                               som_type,
                                                               som_qty,
                                                               vpn,
                                                               season,
                                                               ref_1,
                                                               ref_2,
                                                               po_type,
                                                               err_ind,
                                                               err_message,
                                                               create_id,
                                                               create_datetime,
                                                               last_update_id,
                                                               last_update_datetime)
                                                        SELECT 'N' sel_ind,
                                                                %s alloc_no,
                                                                doc_type alloc_criteria,
                                                                item,
                                                                item_desc,
                                                                diff_id,   
                                                                loc,
                                                                hier1,
                                                                hier2,
                                                                hier3,
                                                                pack_ind,
                                                                inner_size,
                                                                case_size,
                                                                tsf_qty available_qty,
                                                                inactive_qty,
                                                                NULL holdback_qty,
                                                                NULL holdback_type,
                                                                %s alloc_type,
                                                                COALESCE((SELECT MAX('Y')
                                                                            FROM alloc_size_profile sp
                                                                           WHERE sp.item_parent = i.item
                                                                             AND sp.aggr_diff_id = i.diff_id
                                                                             AND sp.status = 'A'
                                                                             AND curdate() <= sp.end_date
                                                                             AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                      THEN curdate()
                                                                                                                      ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                 END v_date) and curdate()
                                                                             AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                              THEN curdate()
                                                                                              ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                         END v_date) <= sp.create_datetime
                                                                           LIMIT 1),'N') size_prf_ind,
                                                                substitute_ind,
                                                                clearance_ind,
                                                                invent_ind,
                                                                'N' split_ind,
                                                                calc_multiple som_type,
                                                                som_qty,
                                                                UPPER(vpn) vpn,
                                                                (SELECT user_attr_value
                                                                   FROM user_attr_item
                                                                  WHERE user_attr_id = 41
                                                                    AND user_attr_value=season_code) season,
                                                                doc_id ref_1,
                                                                doc_desc ref_2,
                                                                NULL po_type,
                                                                NULL err_ind,
                                                                NULL err_message,
                                                                USER() create_id,
                                                                CURDATE() create_datetime,
                                                                USER() last_update_id,
                                                                CURRENT_TIMESTAMP() last_update_datetime
                                                           FROM (SELECT gtt.item item,
                                                                        (SELECT im.item_desc
                                                                           FROM item_dtl im
                                                                          WHERE im.item = gtt.item) item_desc,
                                                                        gtt.color_diff_id diff_id,
                                                                        gtt.location loc,
                                                                        MAX(gtt.hier1) hier1,
                                                                        MAX(gtt.hier2) hier2,
                                                                        MAX(gtt.hier3) hier3,
                                                                        0 holdback_qty,
                                                                        NULL holdback_qty_type,
                                                                        MAX(DATE(th.delivery_date)) delivery_date,
                                                                        SUM(GREATEST(COALESCE(CASE WHEN ilc.status in ('A','C') THEN td.transfered_qty ELSE 0 END,0)
                                                                                     - COALESCE(CASE WHEN ilc.status in ('A','C') THEN td.shipped_qty ELSE 0 END, 0)
                                                                                     - COALESCE(CASE WHEN ilc.status in ('A','C') THEN td.cancelled_qty ELSE 0 END, 0)
                                                                                     - COALESCE((SELECT COALESCE(SUM(GREATEST(d.alloc_qty, 0)),0)
                                                                                                                         FROM alloc_sku_head h,
                                                                                                                              alloc_dtl d,
                                                                                                                              item_location ilc1
                                                                                                                        WHERE h.item = gtt.item
                                                                                                                          AND h.wh = gtt.location
                                                                                                                          AND ilc1.location = gtt.location
                                                                                                                          AND ilc1.item = gtt.item
                                                                                                                          AND ilc1.status in ('A','C')
                                                                                                                          AND h.status IN ('A','R')
                                                                                                                          AND h.ref_type='TSF'
                                                                                                                          AND th.tsf_id = h.order_no
                                                                                                                          AND d.alloc_no = h.alloc_no
                                                                                                                          AND d.alloc_qty > 0),0),0)) tsf_qty,
                                                                        COALESCE(SUM(GREATEST(COALESCE(CASE WHEN ilc.status in ('I') THEN td.transfered_qty ELSE 0 END,0)
                                                                                              - COALESCE(CASE WHEN ilc.status in ('I') THEN td.shipped_qty ELSE 0 END, 0)
                                                                                              - COALESCE(CASE WHEN ilc.status in ('I') THEN td.cancelled_qty ELSE 0 END, 0)
                                                                                              - COALESCE((SELECT COALESCE(SUM(GREATEST(d.alloc_qty,0)),0)
                                                                                                                                  FROM alloc_sku_head h,
                                                                                                                                       alloc_dtl d,
                                                                                                                                       item_location ilc1
                                                                                                                                 WHERE h.item = gtt.item
                                                                                                                                   AND h.wh = gtt.location
                                                                                                                                   AND ilc1.location = gtt.location
                                                                                                                                   AND ilc1.item = gtt.item
                                                                                                                                   AND ilc1.status in ('I')
                                                                                                                                   AND h.status IN ('A','R')
                                                                                                                                   AND h.ref_type='TSF'
                                                                                                                                   AND th.tsf_id = h.order_no
                                                                                                                                   AND d.alloc_no = h.alloc_no
                                                                                                                                   AND d.alloc_qty > 0),0),0)),0)    inactive_qty,
                                                                        th.tsf_id doc_id,
                                                                        CONCAT(th.tsf_id,'/',th.approval_datetime) doc_desc,
                                                                        'T' doc_type,
                                                                        'N' size_profile_ind,
                                                                        MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                        MAX(ilc.clearance_ind) clearance_ind,
                                                                        MAX(gtt.invent_ind) invent_ind,
                                                                        (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                        MAX(isc.inner_pack_size) inner_size,
                                                                        MAX(isc.supp_pack_size)  case_size,
                                                                        MAX(gtt.selling_uom)     calc_multiple,
                                                                        MAX(CASE
                                                                                WHEN gtt.selling_uom = 'I'
                                                                                THEN isc.inner_pack_size
                                                                                WHEN gtt.selling_uom = 'C'
                                                                                THEN isc.supp_pack_size
                                                                                ELSE 1
                                                                            END) som_qty,
                                                                        MAX(isp.product_num)     vpn,
                                                                        MAX(uil.user_attr_value) season_code
                                                                   FROM alloc_items_srch_temp gtt
                                                              LEFT JOIN subs_item_dtl si 
                                                                     ON (gtt.item = si.item
                                                                    AND gtt.location = si.location)
                                                              LEFT JOIN user_attr_item uil 
                                                                     ON (gtt.item = uil.item
                                                                    AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                        tsf_dtl                    th,
                                                                        tsf_item_loc               td,
                                                                        item_location              ilc,
                                                                        item_sups                  isp,
                                                                        item_sup_location          isc
                                                                  WHERE gtt.item = td.item
                                                                    AND gtt.location = th.to_location
                                                                    AND td.tsf_id = th.tsf_id
                                                                    AND th.to_location_type='W'
                                                                    AND th.from_location_type='W'
                                                                    AND th.tsf_type IN ('SR','CF','AD','MR','EG','AIP','IC')
                                                                    AND th.approval_datetime is NOT NULL 
                                                                    AND curdate() <= date_add(th.approval_datetime,interval 1 day)
                                                                    AND th.status <> 'I'
                                                                    AND gtt.item  = ilc.item
                                                                    AND gtt.location = ilc.location
                                                                    AND ilc.status IN ('A', 'C','I')
                                                                    AND isp.item = gtt.item
                                                                    AND isp.primary_supp_ind = 'Y'
                                                                    AND isc.item = isp.item
                                                                    AND isc.supplier = isp.item_supp
                                                                    AND isc.primary_country_ind = 'Y' 
                                                                    AND ilc.clearance_ind = COALESCE(%s,ilc.clearance_ind)
                                                               GROUP BY gtt.item,
                                                                        th.tsf_id,
                                                                        th.approval_datetime,
                                                                        gtt.rollup_item,
                                                                        gtt.location,
                                                                        gtt.color_diff_id,
                                                                        (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i
                                                          WHERE i.tsf_qty >=1; "

  Q_ins_style_item_srch_tsf: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                                     alloc_no,
                                                                     alloc_criteria,
                                                                     item,
                                                                     item_desc,
                                                                     diff_id,
                                                                     loc,
                                                                     hier1,
                                                                     hier2,
                                                                     hier3,
                                                                     pack_ind,
                                                                     inner_size,
                                                                     case_size,
                                                                     avail_qty,
                                                                     inactive_qty,
                                                                     holdback_qty,
                                                                     holdback_type,
                                                                     alloc_type,
                                                                     size_prf_ind,
                                                                     substitute_ind,
                                                                     clearance_ind,
                                                                     invent_ind,
                                                                     split_ind,
                                                                     som_type,
                                                                     som_qty,
                                                                     vpn,
                                                                     season,
                                                                     ref_1,
                                                                     ref_2,
                                                                     po_type,
                                                                     err_ind,
                                                                     err_message,
                                                                     create_id,
                                                                     create_datetime,
                                                                     last_update_id,
                                                                     last_update_datetime)
                                                              SELECT 'N' sel_ind,
                                                                      %s alloc_no,
                                                                      doc_type alloc_criteria,
                                                                      item,
                                                                      item_desc,
                                                                      diff_id,   
                                                                      loc,
                                                                      hier1,
                                                                      hier2,
                                                                      hier3,
                                                                      pack_ind,
                                                                      inner_size,
                                                                      case_size,
                                                                      tsf_qty available_qty,
                                                                      inactive_qty,
                                                                      NULL holdback_qty,
                                                                      NULL holdback_type,
                                                                      %s alloc_type,
                                                                      COALESCE((SELECT MAX('Y')
                                                                                  FROM alloc_size_profile sp
                                                                                 WHERE sp.item_parent = i.item
                                                                                   AND sp.aggr_diff_id = i.diff_id
                                                                                   AND sp.status = 'A'
                                                                                   AND curdate() <= sp.end_date
                                                                                   AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                            THEN curdate()
                                                                                                                            ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                       END v_date) and curdate()
                                                                                   AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                    THEN curdate()
                                                                                                    ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                               END v_date) <= sp.create_datetime
                                                                                 LIMIT 1),'N') size_prf_ind,
                                                                      substitute_ind,
                                                                      clearance_ind,
                                                                      invent_ind,
                                                                      'N' split_ind,
                                                                      calc_multiple som_type,
                                                                      som_qty,
                                                                      UPPER(vpn) vpn,
                                                                      (SELECT user_attr_value
                                                                         FROM user_attr_item
                                                                        WHERE user_attr_id = 41
                                                                          AND user_attr_value=season_code) season,
                                                                      doc_id ref_1,
                                                                      doc_desc ref_2,
                                                                      NULL po_type,
                                                                      NULL err_ind,
                                                                      NULL err_message,
                                                                      USER() create_id,
                                                                      CURDATE() create_datetime,
                                                                      USER() last_update_id,
                                                                      CURRENT_TIMESTAMP() last_update_datetime
                                                                 FROM (SELECT gtt.rollup_item           item,
                                                                              MAX(gtt.rollup_item_desc) item_desc,
                                                                              gtt.color_diff_id diff_id,
                                                                              gtt.location loc,
                                                                              MAX(gtt.hier1) hier1,
                                                                              MAX(gtt.hier2) hier2,
                                                                              MAX(gtt.hier3) hier3,
                                                                              0 holdback_qty,
                                                                              NULL holdback_qty_type,
                                                                              MAX(DATE(th.delivery_date)) delivery_date,
                                                                              SUM(GREATEST(COALESCE(CASE WHEN ilc.status in ('A','C') THEN td.transfered_qty ELSE 0 END,0)
                                                                                           - COALESCE(CASE WHEN ilc.status in ('A','C') THEN td.shipped_qty ELSE 0 END, 0)
                                                                                           - COALESCE(CASE WHEN ilc.status in ('A','C') THEN td.cancelled_qty ELSE 0 END, 0)
                                                                                           - COALESCE((SELECT COALESCE(SUM(GREATEST(d.alloc_qty, 0)),0)
                                                                                                                               FROM alloc_sku_head h,
                                                                                                                                    alloc_dtl d,
                                                                                                                                    item_location ilc1
                                                                                                                              WHERE h.item = gtt.item
                                                                                                                                AND h.wh = gtt.location
                                                                                                                                AND ilc1.location = gtt.location
                                                                                                                                AND ilc1.item = gtt.item
                                                                                                                                AND ilc1.status in ('A','C')
                                                                                                                                AND h.status IN ('A','R')
                                                                                                                                AND h.ref_type='TSF'
                                                                                                                                AND th.tsf_id = h.order_no
                                                                                                                                AND d.alloc_no = h.alloc_no
                                                                                                                                AND d.alloc_qty > 0),0),0)) tsf_qty,
                                                                              COALESCE(SUM(GREATEST(COALESCE(CASE WHEN ilc.status in ('I') THEN td.transfered_qty ELSE 0 END,0)
                                                                                                    - COALESCE(CASE WHEN ilc.status in ('I') THEN td.shipped_qty ELSE 0 END, 0)
                                                                                                    - COALESCE(CASE WHEN ilc.status in ('I') THEN td.cancelled_qty ELSE 0 END, 0)
                                                                                                    - COALESCE((SELECT COALESCE(SUM(GREATEST(d.alloc_qty,0)),0)
                                                                                                                                        FROM alloc_sku_head h,
                                                                                                                                             alloc_dtl d,
                                                                                                                                             item_location ilc1
                                                                                                                                       WHERE h.item = gtt.item
                                                                                                                                         AND h.wh = gtt.location
                                                                                                                                         AND ilc1.location = gtt.location
                                                                                                                                         AND ilc1.item = gtt.item
                                                                                                                                         AND ilc1.status in ('I')
                                                                                                                                         AND h.status IN ('A','R')
                                                                                                                                         AND h.ref_type='TSF'
                                                                                                                                         AND th.tsf_id = h.order_no
                                                                                                                                         AND d.alloc_no = h.alloc_no
                                                                                                                                         AND d.alloc_qty > 0),0),0)),0) inactive_qty,
                                                                              th.tsf_id doc_id,
                                                                              CONCAT(th.tsf_id,'/',th.approval_datetime) doc_desc,
                                                                              'T' doc_type,
                                                                              'N' size_profile_ind,
                                                                              MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                              MAX(ilc.clearance_ind) clearance_ind,
                                                                              MAX(gtt.invent_ind) invent_ind,
                                                                              (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                              MAX(isc.inner_pack_size) inner_size,
                                                                              MAX(isc.supp_pack_size)  case_size,
                                                                              MAX(gtt.selling_uom)     calc_multiple,
                                                                              MAX(CASE
                                                                                      WHEN gtt.selling_uom = 'I'
                                                                                      THEN isc.inner_pack_size
                                                                                      WHEN gtt.selling_uom = 'C'
                                                                                      THEN isc.supp_pack_size
                                                                                      ELSE 1
                                                                                  END) som_qty,
                                                                              MAX(isp.product_num)     vpn,
                                                                              MAX(uil.user_attr_value) season_code
                                                                         FROM alloc_items_srch_temp gtt
                                                                    LEFT JOIN subs_item_dtl si 
                                                                           ON (gtt.item = si.item
                                                                          AND gtt.location = si.location)
                                                                    LEFT JOIN user_attr_item uil 
                                                                           ON (gtt.item = uil.item
                                                                          AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                              tsf_dtl                    th,
                                                                              tsf_item_loc               td,
                                                                              item_location              ilc,
                                                                              item_sups                  isp,
                                                                              item_sup_location          isc
                                                                        WHERE gtt.item = td.item
                                                                          AND gtt.location = th.to_location
                                                                          AND td.tsf_id = th.tsf_id
                                                                          AND th.to_location_type='W'
                                                                          AND th.from_location_type='W'
                                                                          AND th.tsf_type IN ('SR','CF','AD','MR','EG','AIP','IC')
                                                                          AND th.approval_datetime is NOT NULL 
                                                                          AND curdate() <= date_add(th.approval_datetime,interval 1 day)
                                                                          AND th.status <> 'I'
                                                                          AND gtt.item  = ilc.item
                                                                          AND gtt.location = ilc.location
                                                                          AND ilc.status IN ('A', 'C','I')
                                                                          AND isp.item = gtt.item
                                                                          AND isp.primary_supp_ind = 'Y'
                                                                          AND isc.item = isp.item
                                                                          AND isc.supplier = isp.item_supp
                                                                          AND isc.primary_country_ind = 'Y' 
                                                                          AND ilc.clearance_ind = COALESCE(%s,ilc.clearance_ind)
                                                                     GROUP BY gtt.rollup_item,
                                                                              th.tsf_id,
                                                                              th.approval_datetime,
                                                                              gtt.rollup_item,
                                                                              gtt.location,
                                                                              gtt.color_diff_id,
                                                                              (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i
                                                                WHERE i.tsf_qty >=1; "

get_asn_source_inv:
  Q_ins_item_srch_asn: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                               alloc_no,
                                                               alloc_criteria,
                                                               item,
                                                               item_desc,
                                                               diff_id,
                                                               loc,
                                                               hier1,
                                                               hier2,
                                                               hier3,
                                                               pack_ind,
                                                               inner_size,
                                                               case_size,
                                                               avail_qty,
                                                               inactive_qty,
                                                               holdback_qty,
                                                               holdback_type,
                                                               alloc_type,
                                                               size_prf_ind,
                                                               substitute_ind,
                                                               clearance_ind,
                                                               invent_ind,
                                                               split_ind,
                                                               som_type,
                                                               som_qty,
                                                               vpn,
                                                               season,
                                                               ref_1,
                                                               ref_2,
                                                               po_type,
                                                               err_ind,
                                                               err_message,
                                                               create_id,
                                                               create_datetime,
                                                               last_update_id,
                                                               last_update_datetime)
                                                        SELECT 'N' sel_ind,
                                                                %s alloc_no,
                                                                doc_type alloc_criteria,
                                                                item,
                                                                item_desc,
                                                                diff_id,   
                                                                loc,
                                                                hier1,
                                                                hier2,
                                                                hier3,
                                                                pack_ind,
                                                                inner_size,
                                                                case_size,
                                                                (ship_qty-COALESCE((SELECT SUM(alloc_qty)
                                                                                      FROM alloc_dtl ad,
                                                                                           alloc_sku_head ah,
                                                                                           alloc_xref alx
                                                                                     WHERE ah.alloc_no = ad.alloc_no
                                                                                       AND ah.alloc_no = alx.xref_alloc_no
                                                                                       AND ah.item IN (SELECT item
                                                                                                         FROM item_dtl
                                                                                                        WHERE item = i.item
                                                                                                          AND COALESCE(diff_id,'$') = COALESCE(i.diff_id,'$'))
                                                                                       AND ah.wh=i.loc
                                                                                       AND ah.ref_type='PO'
                                                                                       AND COALESCE(ah.ref_no,'$')=i.asn_id
                                                                                       AND ah.order_no=i.order_no),0)) available_qty,
                                                                NULL inactive_qty,
                                                                NULL holdback_qty,
                                                                NULL holdback_type,
                                                                %s alloc_type,
                                                                COALESCE((SELECT MAX('Y')
                                                                            FROM alloc_size_profile sp
                                                                           WHERE sp.item_parent = i.item
                                                                             AND sp.aggr_diff_id = i.diff_id
                                                                             AND sp.status = 'A'
                                                                             AND estimated_instock_date <= sp.end_date
                                                                             AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                      THEN curdate()
                                                                                                                      ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                 END v_date) and estimated_instock_date
                                                                             AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                              THEN curdate()
                                                                                              ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                         END v_date) <= sp.create_datetime
                                                                LIMIT 1),'N') size_prf_ind,
                                                                substitute_ind,
                                                                clearance_ind,
                                                                invent_ind,
                                                                'N' split_ind,
                                                                calc_multiple som_type,
                                                                som_qty,
                                                                UPPER(vpn) vpn,
                                                                (SELECT user_attr_value
                                                                   FROM user_attr_item
                                                                  WHERE user_attr_id = 41
                                                                    AND user_attr_value=season_code) season,
                                                                order_no ref_1,
                                                                doc_desc ref_2,
                                                                po_type,
                                                                NULL err_ind,
                                                                NULL err_message,
                                                                USER() create_id,
                                                                CURDATE() create_datetime,
                                                                USER() last_update_id,
                                                                CURRENT_TIMESTAMP() last_update_datetime
                                                           FROM (SELECT gtt.item item,
                                                                        (SELECT im.item_desc
                                                                           FROM item_dtl im
                                                                          WHERE im.item = gtt.item) item_desc,
                                                                        gtt.color_diff_id diff_id,
                                                                        gtt.location loc,
                                                                        MAX(gtt.hier1) hier1,
                                                                        MAX(gtt.hier2) hier2,
                                                                        MAX(gtt.hier3) hier3,
                                                                        0 holdback_qty,
                                                                        NULL holdback_qty_type,
                                                                        MAX(po_type) po_type,
                                                                        MAX(DATE(ol.instock_date)) estimated_instock_date,
                                                                        MAX(sh.po_no) order_no,
                                                                        MAX(DATE(sh.est_arrival_date)) est_arrival_date,
                                                                        SUM(COALESCE(CASE WHEN ilc.status in ('A','C') THEN ss.qty_expected ELSE 0 END,0)
                                                                            - COALESCE(CASE WHEN ilc.status in ('A','C') THEN ss.qty_received ELSE 0 END, 0)) ship_qty,
                                                                        CONCAT(sh.shipment_date,'/',sh.asn_id,'/',sh.po_no) doc_desc,
                                                                        'A' doc_type,
                                                                        sh.asn_id,
                                                                        'N' size_profile_ind,
                                                                        MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                        MAX(ilc.clearance_ind) clearance_ind,
                                                                        MAX(gtt.invent_ind) invent_ind,
                                                                        (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                        MAX(isc.inner_pack_size) inner_size,
                                                                        MAX(isc.supp_pack_size) case_size,
                                                                        MAX(gtt.selling_uom) calc_multiple,
                                                                        MAX(CASE
                                                                                WHEN gtt.selling_uom = 'I'
                                                                                THEN isc.inner_pack_size
                                                                                WHEN gtt.selling_uom = 'C'
                                                                                THEN isc.supp_pack_size
                                                                                ELSE 1
                                                                            END) som_qty,
                                                                        MAX(isp.product_num) vpn,
                                                                        MAX(uil.user_attr_value) season_code
                                                                   FROM alloc_items_srch_temp gtt
                                                              LEFT JOIN subs_item_dtl si 
                                                                     ON (gtt.item = si.item
                                                                    AND gtt.location = si.location)
                                                              LEFT JOIN user_attr_item uil 
                                                                     ON (gtt.item = uil.item
                                                                    AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                        ship_dtl                   sh,
                                                                        ship_item                  ss,
                                                                        warehouse                  w,
                                                                        po_dtl                     oh,
                                                                        po_item_loc                ol,
                                                                        item_location              ilc,
                                                                        item_sups                  isp,
                                                                        item_sup_location          isc
                                                                  WHERE gtt.item   = ss.item
                                                                    AND sh.ship_id = ss.shipment
                                                                    AND sh.asn_id IS NOT NULL
                                                                    AND sh.po_no  IS NOT NULL
                                                                    AND sh.received_date is NULL
                                                                    AND sh.ship_status = 'I'
                                                                    AND ol.po_no      = sh.po_no
                                                                    AND ol.item       =  ss.item
                                                                    AND gtt.location  = ol.location
                                                                    AND gtt.item      = ilc.item
                                                                    AND gtt.location  = ilc.location
                                                                    AND gtt.location  = w.wh
                                                                    AND w.physical_wh = sh.to_location
                                                                    AND sh.po_no  = oh.po_no
                                                                    AND oh.status = 'A'
                                                                    AND ilc.status IN ('A','C','I')
                                                                    AND isp.item = gtt.item
                                                                    AND isc.item = isp.item
                                                                    AND isc.supplier = isp.item_supp
                                                                    AND isc.primary_country_ind = 'Y'
                                                                    AND isp.primary_supp_ind    = 'Y'
                                                                    AND ilc.clearance_ind       = COALESCE(%s,ilc.clearance_ind)
                                                               GROUP BY gtt.item,
                                                                        sh.shipment_date,
                                                                        sh.asn_id,
                                                                        sh.po_no,
                                                                        gtt.rollup_item,
                                                                        gtt.location,
                                                                        gtt.color_diff_id,
                                                                        (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i
                                                          WHERE (i.ship_qty-COALESCE((SELECT SUM(alloc_qty)
                                                                                        FROM alloc_dtl ad,
                                                                                             alloc_sku_head ah,
                                                                                             alloc_xref alx
                                                                                       WHERE ah.alloc_no = ad.alloc_no
                                                                                         AND ah.alloc_no = alx.xref_alloc_no
                                                                                         AND ah.item IN (SELECT item
                                                                                                           FROM item_dtl
                                                                                                          WHERE item = i.item
                                                                                                            AND COALESCE(diff_id,'$') = COALESCE(i.diff_id,'$'))
                                                                                         AND ah.wh=i.loc
                                                                                         AND ah.ref_type='PO'
                                                                                         AND COALESCE(ah.ref_no,'$')=i.asn_id
                                                                                         AND ah.order_no=i.order_no),0)) >= 1; "

  Q_ins_style_item_srch_asn: " INSERT INTO alloc_itm_search_dtl_temp(sel_ind,
                                                                     alloc_no,
                                                                     alloc_criteria,
                                                                     item,
                                                                     item_desc,
                                                                     diff_id,
                                                                     loc,
                                                                     hier1,
                                                                     hier2,
                                                                     hier3,
                                                                     pack_ind,
                                                                     inner_size,
                                                                     case_size,
                                                                     avail_qty,
                                                                     inactive_qty,
                                                                     holdback_qty,
                                                                     holdback_type,
                                                                     alloc_type,
                                                                     size_prf_ind,
                                                                     substitute_ind,
                                                                     clearance_ind,
                                                                     invent_ind,
                                                                     split_ind,
                                                                     som_type,
                                                                     som_qty,
                                                                     vpn,
                                                                     season,
                                                                     ref_1,
                                                                     ref_2,
                                                                     po_type,
                                                                     err_ind,
                                                                     err_message,
                                                                     create_id,
                                                                     create_datetime,
                                                                     last_update_id,
                                                                     last_update_datetime)
                                                              SELECT 'N' sel_ind,
                                                                      %s alloc_no,
                                                                      doc_type alloc_criteria,
                                                                      item,
                                                                      item_desc,
                                                                      diff_id,   
                                                                      loc,
                                                                      hier1,
                                                                      hier2,
                                                                      hier3,
                                                                      pack_ind,
                                                                      inner_size,
                                                                      case_size,
                                                                      (ship_qty-COALESCE((SELECT SUM(alloc_qty)
                                                                                            FROM alloc_dtl ad,
                                                                                                 alloc_sku_head ah,
                                                                                                 alloc_xref alx
                                                                                           WHERE ah.alloc_no = ad.alloc_no
                                                                                             AND ah.alloc_no = alx.xref_alloc_no
                                                                                             AND ah.item IN (SELECT item
                                                                                                               FROM item_dtl
                                                                                                              WHERE item = i.item
                                                                                                                AND COALESCE(diff_id,'$') = COALESCE(i.diff_id,'$'))
                                                                                             AND ah.wh=i.loc
                                                                                             AND ah.ref_type='PO'
                                                                                             AND COALESCE(ah.ref_no,'$')=i.asn_id
                                                                                             AND ah.order_no=i.order_no),0)) available_qty,
                                                                      NULL inactive_qty,
                                                                      NULL holdback_qty,
                                                                      NULL holdback_type,
                                                                      %s alloc_type,
                                                                      COALESCE((SELECT MAX('Y')
                                                                                  FROM alloc_size_profile sp
                                                                                 WHERE sp.item_parent = i.item
                                                                                   AND sp.aggr_diff_id = i.diff_id
                                                                                   AND sp.status = 'A'
                                                                                   AND estimated_instock_date <= sp.end_date
                                                                                   AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                            THEN curdate()
                                                                                                                            ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                       END v_date) and estimated_instock_date
                                                                                   AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                    THEN curdate()
                                                                                                    ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                               END v_date) <= sp.create_datetime
                                                                      LIMIT 1),'N') size_prf_ind,
                                                                      substitute_ind,
                                                                      clearance_ind,
                                                                      invent_ind,
                                                                      'N' split_ind,
                                                                      calc_multiple som_type,
                                                                      som_qty,
                                                                      UPPER(vpn) vpn,
                                                                      (SELECT user_attr_value
                                                                         FROM user_attr_item
                                                                        WHERE user_attr_id = 41
                                                                          AND user_attr_value=season_code) season,
                                                                      order_no ref_1,
                                                                      doc_desc ref_2,
                                                                      po_type,
                                                                      NULL err_ind,
                                                                      NULL err_message,
                                                                      USER() create_id,
                                                                      CURDATE() create_datetime,
                                                                      USER() last_update_id,
                                                                      CURRENT_TIMESTAMP() last_update_datetime
                                                                 FROM (SELECT gtt.rollup_item           item,
                                                                              MAX(gtt.rollup_item_desc) item_desc,
                                                                              gtt.color_diff_id diff_id,
                                                                              gtt.location loc,
                                                                              MAX(gtt.hier1) hier1,
                                                                              MAX(gtt.hier2) hier2,
                                                                              MAX(gtt.hier3) hier3,
                                                                              0 holdback_qty,
                                                                              NULL holdback_qty_type,
                                                                              MAX(po_type) po_type,
                                                                              MAX(DATE(ol.instock_date)) estimated_instock_date,
                                                                              MAX(sh.po_no) order_no,
                                                                              MAX(DATE(sh.est_arrival_date)) est_arrival_date,
                                                                              SUM(COALESCE(CASE WHEN ilc.status in ('A','C') THEN ss.qty_expected ELSE 0 END,0)
                                                                                  - COALESCE(CASE WHEN ilc.status in ('A','C') THEN ss.qty_received ELSE 0 END, 0)) ship_qty,
                                                                              CONCAT(sh.shipment_date,'/',sh.asn_id,'/',sh.po_no) doc_desc,
                                                                              'A' doc_type,
                                                                              sh.asn_id,
                                                                              'N' size_profile_ind,
                                                                              MAX(CASE WHEN si.item IS NOT NULL THEN 'Y' ELSE 'N' END) substitute_ind,
                                                                              MAX(ilc.clearance_ind) clearance_ind,
                                                                              MAX(gtt.invent_ind) invent_ind,
                                                                              (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END) pack_ind,
                                                                              MAX(isc.inner_pack_size) inner_size,
                                                                              MAX(isc.supp_pack_size) case_size,
                                                                              MAX(gtt.selling_uom) calc_multiple,
                                                                              MAX(CASE
                                                                                      WHEN gtt.selling_uom = 'I'
                                                                                      THEN isc.inner_pack_size
                                                                                      WHEN gtt.selling_uom = 'C'
                                                                                      THEN isc.supp_pack_size
                                                                                      ELSE 1
                                                                                  END) som_qty,
                                                                              MAX(isp.product_num) vpn,
                                                                              MAX(uil.user_attr_value) season_code
                                                                         FROM alloc_items_srch_temp gtt
                                                                    LEFT JOIN subs_item_dtl si 
                                                                           ON (gtt.item = si.item
                                                                          AND gtt.location = si.location)
                                                                    LEFT JOIN user_attr_item uil 
                                                                           ON (gtt.item = uil.item
                                                                          AND COALESCE(uil.user_attr_id,-1) = 41),
                                                                              ship_dtl                   sh,
                                                                              ship_item                  ss,
                                                                              warehouse                  w,
                                                                              po_dtl                     oh,
                                                                              po_item_loc                ol,
                                                                              item_location              ilc,
                                                                              item_sups                  isp,
                                                                              item_sup_location          isc
                                                                        WHERE gtt.item   = ss.item
                                                                          AND sh.ship_id = ss.shipment
                                                                          AND sh.asn_id IS NOT NULL
                                                                          AND sh.po_no  IS NOT NULL
                                                                          AND sh.received_date is NULL
                                                                          AND sh.ship_status = 'I'
                                                                          AND ol.po_no      = sh.po_no
                                                                          AND ol.item       =  ss.item
                                                                          AND gtt.location  = ol.location
                                                                          AND gtt.item      = ilc.item
                                                                          AND gtt.location  = ilc.location
                                                                          AND gtt.location  = w.wh
                                                                          AND w.physical_wh = sh.to_location
                                                                          AND sh.po_no  = oh.po_no
                                                                          AND oh.status = 'A'
                                                                          AND ilc.status IN ('A','C','I')
                                                                          AND isp.item = gtt.item
                                                                          AND isc.item = isp.item
                                                                          AND isc.supplier = isp.item_supp
                                                                          AND isc.primary_country_ind = 'Y'
                                                                          AND isp.primary_supp_ind    = 'Y'
                                                                          AND ilc.clearance_ind       = COALESCE(%s,ilc.clearance_ind)
                                                                     GROUP BY gtt.rollup_item,
                                                                              sh.shipment_date,
                                                                              sh.asn_id,
                                                                              sh.po_no,
                                                                              gtt.rollup_item,
                                                                              gtt.location,
                                                                              gtt.color_diff_id,
                                                                              (CASE WHEN gtt.rollup_type = 'PACK' THEN 'Y' ELSE 'N' END)) i
                                                                WHERE (i.ship_qty-COALESCE((SELECT SUM(alloc_qty)
                                                                                              FROM alloc_dtl ad,
                                                                                                   alloc_sku_head ah,
                                                                                                   alloc_xref alx
                                                                                             WHERE ah.alloc_no = ad.alloc_no
                                                                                               AND ah.alloc_no = alx.xref_alloc_no
                                                                                               AND ah.item IN (SELECT item
                                                                                                                 FROM item_dtl
                                                                                                                WHERE item = i.item
                                                                                                                  AND COALESCE(diff_id,'$') = COALESCE(i.diff_id,'$'))
                                                                                               AND ah.wh=i.loc
                                                                                               AND ah.ref_type='PO'
                                                                                               AND COALESCE(ah.ref_no,'$')=i.asn_id
                                                                                               AND ah.order_no=i.order_no),0)) >= 1; "

mark_rollup_group:
  Q_del_itm_srch_tmp: "DELETE FROM alloc_items_srch_temp;"

  Q_ins_itm_srch_tmp: "INSERT INTO alloc_items_srch_temp (item,
                                                          location,
                                                          rollup_type,
                                                          rollup_item,
                                                          rollup_item_desc,
                                                          multi_color_pack_ind,
                                                          color_diff_id,
                                                          selling_uom,
                                                          invent_ind,
                                                          hier1,
                                                          hier2,
                                                          hier3)
                                    SELECT distinct gtt.item,
                                           gtt.location,
                                           MAX(CASE WHEN  id.pack_ind = 'Y' THEN 'PACK' ELSE 'STYLE' END) rollup_type,
                                           id.item_parent rollup_item,
                                           (SELECT imp.item_desc
                                              FROM item_dtl imp
                                             WHERE imp.item =  id.item
                                              LIMIT 1)
                                               rollup_item_desc,
                                           NULL multi_color_pack_ind,
                                           /*DECODE(NVL(a id.aggr_diff_id_column || '~' || a id.aggr_diff_id,'$'),'~',NULL,NVL(a id.aggr_diff_id_column || '~' || a id.aggr_diff_id,'$')) color_diff_id,*/
                                           id.diff1 color_diff_id,
                                            id.selling_uom,
                                            NULL invent_ind,
                                            id.hier1,
                                            id.hier2,
                                            id.hier3
                                      FROM alloc_search_criteria_itm_temp gtt,
                                           item_dtl                     id
                                     WHERE id.item = gtt.item
                                       AND id.item_level =  id.tran_level
                                       AND id.status = 'A'
                                     GROUP BY gtt.item, 
                                           gtt.location,
                                            id.item_parent,
                                            id.selling_uom,
                                            id.hier1,
                                            id.hier2,
                                            id.hier3;"

  Q_ins_style_itm_srch_tmp: " INSERT INTO alloc_items_srch_temp (item,
                                                                 location,
                                                                 rollup_type,
                                                                 rollup_item,
                                                                 rollup_item_desc,
                                                                 multi_color_pack_ind,
                                                                 color_diff_id,
                                                                 selling_uom,
                                                                 invent_ind,
                                                                 hier1,
                                                                 hier2,
                                                                 hier3)
                                                          SELECT DISTINCT gtt.item,
                                                                 gtt.location,
                                                                 'STYLE' rollup_type,
                                                                 im.item_parent rollup_item,
                                                                 (SELECT imp.item_desc
                                                                    FROM item_dtl imp
                                                                   WHERE imp.item = im.item_parent
                                                                    LIMIT 1) rollup_item_desc,
                                                                 NULL multi_color_pack_ind,
                                                                 aim.diff1,
                                                                 im.selling_uom,
                                                                 NULL invent_ind,
                                                                 im.hier1,
                                                                 im.hier2,
                                                                 im.hier3
                                                            FROM alloc_search_criteria_itm_temp  gtt,
                                                                 item_dtl                        im,
                                                                 item_dtl                        aim,
                                                                 item_dtl                        aimp 
                                                           WHERE im.item         = gtt.item
                                                             AND im.item_level   = im.tran_level
                                                             AND im.tran_level   = 2
                                                             AND im.status       = 'A'
                                                             AND aim.item        = im.item
                                                             AND aim.item_parent = aimp.item_parent
                                                             AND aim.diff1       = aimp.diff1
                                                        GROUP BY gtt.item, 
                                                                 gtt.location,
                                                                 im.item_parent,
                                                                 aim.diff1,
                                                                 aim.diff1,
                                                                 im.selling_uom,
                                                                 hier1,
                                                                 hier2,
                                                                 hier3; "

fetch_inventory:
  Q_create_itm_srch_tbl: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_itm_search_dtl_temp(SEL_IND VARCHAR(1) ,
                                                                                        ALLOC_NO NUMERIC(20) ,
                                                                                        ALLOC_CRITERIA VARCHAR(3) ,
                                                                                        ITEM VARCHAR(25) ,
                                                                                        ITEM_DESC VARCHAR(100) ,
                                                                                        DIFF_ID VARCHAR(15) ,
                                                                                        LOC NUMERIC(10) ,
                                                                                        HIER1 VARCHAR(10) ,
                                                                                        HIER2 VARCHAR(10) ,
                                                                                        HIER3 VARCHAR(10) ,
                                                                                        PACK_IND VARCHAR(1) ,
                                                                                        INNER_SIZE DECIMAL(12,4) ,
                                                                                        CASE_SIZE DECIMAL(12,4) ,
                                                                                        AVAIL_QTY NUMERIC(10) ,
                                                                                        INACTIVE_QTY NUMERIC(10) ,
                                                                                        HOLDBACK_QTY NUMERIC(10) ,
                                                                                        HOLDBACK_TYPE VARCHAR(1) ,
                                                                                        ALLOC_TYPE VARCHAR(1) ,
                                                                                        SIZE_PRF_IND VARCHAR(1) ,
                                                                                        SUBSTITUTE_IND VARCHAR(1) ,
                                                                                        CLEARANCE_IND VARCHAR(1) ,
                                                                                        INVENT_IND VARCHAR(1) ,
                                                                                        SPLIT_IND VARCHAR(1) ,
                                                                                        SOM_TYPE VARCHAR(5) ,
                                                                                        SOM_QTY NUMERIC(10) ,
                                                                                        VPN VARCHAR(30) ,
                                                                                        SEASON VARCHAR(500) ,
                                                                                        REF_1 VARCHAR(50) ,
                                                                                        REF_2 VARCHAR(50) ,
                                                                                        PO_TYPE VARCHAR(10) ,
                                                                                        ERR_IND VARCHAR(1) ,
                                                                                        ERR_MESSAGE VARCHAR(50) ,
                                                                                        CREATE_ID VARCHAR(200) ,
                                                                                        CREATE_DATETIME DATE ,
                                                                                        LAST_UPDATE_ID VARCHAR(200) ,
                                                                                        LAST_UPDATE_DATETIME TIMESTAMP);"

  Q_fetch_diff_items: "SELECT DISTINCT item FROM alloc_items_srch_temp WHERE UPPER(color_diff_id) = UPPER(%s);"

  Q_fetch_vpn_items: "SELECT item 
                        FROM alloc_items_srch_temp gtt
                       WHERE EXISTS(SELECT 1
                                      FROM item_sups isup
                                      WHERE isup.item = gtt.item 
                                        AND isup.primary_supp_ind = 'Y'
                                        AND UPPER(isup.product_num) = UPPER(%s));"

  Q_del_ext_item: "DELETE FROM alloc_items_srch_temp WHERE item NOT IN {};"

  Q_ins_itm_srch_dtl_tmp: "INSERT INTO alloc_itm_search_dtl_temp (sel_ind
                                                                  ,alloc_no
                                                                  ,alloc_criteria
                                                                  ,item
                                                                  ,item_desc
                                                                  ,diff_id
                                                                  ,loc
                                                                  ,hier1
                                                                  ,hier2
                                                                  ,hier3
                                                                  ,pack_ind
                                                                  ,inner_size
                                                                  ,case_size
                                                                  ,avail_qty
                                                                  ,inactive_qty
                                                                  ,holdback_qty
                                                                  ,holdback_type
                                                                  ,alloc_type
                                                                  ,size_prf_ind
                                                                  ,substitute_ind
                                                                  ,clearance_ind
                                                                  ,invent_ind
                                                                  ,split_ind
                                                                  ,som_type
                                                                  ,som_qty
                                                                  ,vpn
                                                                  ,season
                                                                  ,ref_1
                                                                  ,ref_2
                                                                  ,po_type
                                                                  ,err_ind
                                                                  ,err_message
                                                                  ,create_id
                                                                  ,create_datetime
                                                                  ,last_update_id
                                                                  ,last_update_datetime)
                                   SELECT 'N' sel_ind,
                                          %s  alloc_no,
                                          %s  alloc_criteria,
                                          item,
                                          item_desc,
                                          diff_id,
                                          loc,
                                          hier1,
                                          hier2,
                                          hier3,
                                          pack_ind,
                                          inner_size,
                                          case_size,
                                          avail_qty,
                                          inactive_qty,
                                          NULL     holdback_qty,
                                          NULL     holdback_type,
                                          %s       alloc_type,
                                          COALESCE((SELECT MAX('Y')
                                                       FROM alloc_size_profile sp
                                                      WHERE sp.item_parent = i.item
                                                        AND sp.aggr_diff_id = i.diff_id
                                                        AND sp.status = 'A'
                                                        AND curdate() <= sp.end_date
                                                        AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                 THEN curdate()
                                                                                                 ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                  END v_date) and curdate()
                                                        AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                         THEN curdate()
                                                                         ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                          END v_date) <= sp.create_datetime
                                                        LIMIT 1),'N') size_prf_ind,
                                          substitute_ind,
                                          clearance_ind,
                                          invent_ind,
                                          'N' split_ind,
                                          calc_multiple som_type,
                                          som_qty,
                                          UPPER(vpn) vpn,
                                          (SELECT user_attr_value_desc
                                             FROM user_attr
                                            WHERE user_attr_id    = 41
                                              AND user_attr_value = season_code
                                            LIMIT 1) season,
                                          NULL ref_1,
                                          NULL ref_2,
                                          NULL po_type,
                                          NULL err_ind,
                                          NULL err_message,
                                          USER() create_id,
                                          CURDATE() create_datetime,
                                          USER() last_update_id,
                                          CURRENT_TIMESTAMP() last_update_datetime
                                     FROM (SELECT gtt.item                      item,
                                                  (SELECT im.item_desc
                                                     FROM item_dtl im
                                                    WHERE im.item = gtt.item
                                                    LIMIT 1)   item_desc,
                                                  gtt.color_diff_id             diff_id,
                                                  gtt.location                  loc,
                                                  MAX(gtt.hier1)                hier1,
                                                  MAX(gtt.hier2)                hier2,
                                                  MAX(gtt.hier3)                hier3,
                                                  0                             holdback_qty,
                                                  NULL                          holdback_type,
                                                  SUM(   GREATEST(COALESCE(GREATEST((CASE WHEN ilc.status in ('A','C') THEN ilc.item_soh ELSE 0 END), 0),0)
                                                       - (COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.reserved_qty ELSE 0 END, 0),0)
                                                       + COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.rtv_qty ELSE 0 END, 0),0)
                                                       + COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.non_sellable_qty ELSE 0 END, 0),0)
                                                       + COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.cust_resv_qty ELSE 0 END, 0),0))
                                                       - (SELECT COALESCE(SUM(GREATEST(d.distro_qty,0)),0)
                                                           FROM alloc_sku_head h,
                                                               po_item_loc    ol,
                                                               po_dtl         oh,
                                                               alloc_dtl      d,
                                                               item_location  ilc1
                                                           WHERE h.item = gtt.item
                                                           AND h.wh = gtt.location
                                                           AND ilc1.location = gtt.location
                                                           AND ilc1.item = gtt.item
                                                           AND ilc1.status in ('A','C')
                                                           AND h.status IN ('A', 'R')
                                                           AND h.order_no IS NOT NULL
                                                           AND ol.po_no = h.order_no
                                                           AND ol.item = h.item
                                                           AND ol.location = h.wh
                                                           AND ol.received_qty > 0
                                                           AND oh.po_no = ol.po_no
                                                           AND oh.status IN ('A', 'C')
                                                           AND d.alloc_no = h.alloc_no
                                                           AND d.alloc_qty > 0
                                                           AND d.alloc_qty > COALESCE(d.tsf_qty, 0)),0)) avail_qty,
                                                  SUM(GREATEST(COALESCE((GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.item_soh ELSE 0 END), 0)),0)
                                                              - (GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.reserved_qty ELSE 0 END), 0)
                                                              + GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.rtv_qty ELSE 0 END), 0)
                                                              + GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.non_sellable_qty ELSE 0 END), 0)
                                                              + GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.cust_resv_qty ELSE 0 END), 0))
                                                              - (SELECT COALESCE(SUM(GREATEST(d.distro_qty,0)),0)
                                                                   FROM alloc_sku_head h,
                                                                        po_item_loc    ol,
                                                                        po_dtl         oh,
                                                                        alloc_dtl      d,
                                                                        item_location  ilc1
                                                                  WHERE h.item = gtt.item
                                                                    AND h.wh = gtt.location
                                                                    AND ilc1.location = gtt.location
                                                                    AND ilc1.item = gtt.item
                                                                    AND ilc1.status in ('I')
                                                                    AND h.status IN ('A', 'R')
                                                                    AND h.order_no IS NOT NULL
                                                                    AND ol.po_no = h.order_no
                                                                    AND ol.item = h.item
                                                                    AND ol.location = h.wh
                                                                    AND ol.received_qty > 0
                                                                    AND oh.po_no = ol.po_no
                                                                    AND oh.status IN ('A', 'C')
                                                                    AND d.alloc_no = h.alloc_no
                                                                    AND d.alloc_qty > 0
                                                                    AND d.alloc_qty >COALESCE(d.tsf_qty, 0)),0)) inactive_qty,
                                                  MAX(CASE
                                                          WHEN si.item IS NOT NULL THEN 'Y'
                                                          ELSE 'N'
                                                       END)                      substitute_ind,
                                                  MAX(ilc.clearance_ind)         clearance_ind,
                                                  MAX(gtt.invent_ind)            invent_ind,
                                                  (CASE
                                                      WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                      ELSE 'N'
                                                   END)                         pack_ind,
                                                  MAX(isc.inner_pack_size)     inner_size,
                                                  MAX(isc.supp_pack_size)      case_size,
                                                  MAX(CASE
                                                          WHEN gtt.selling_uom = 'I' THEN 'I'
                                                          WHEN gtt.selling_uom = 'C' THEN 'C'
                                                          WHEN gtt.selling_uom = 'E' THEN 'E'
                                                          ELSE 'E'
                                                        END)                      calc_multiple,
                                                  MAX(CASE
                                                          WHEN gtt.selling_uom = 'I'
                                                          THEN
                                                              isc.inner_pack_size
                                                          WHEN gtt.selling_uom = 'C'
                                                          THEN
                                                              isc.supp_pack_size
                                                          ELSE
                                                              1
                                                        END)                    som_qty,
                                                  NULL                          capacity,
                                                  NULL                          facility,
                                                  NULL                          like_item_criteria,
                                                  MAX(isp.product_num)         vpn,
                                                  MAX(uil.user_attr_value) season_code
                                                  FROM alloc_items_srch_temp gtt
                                                  LEFT JOIN user_attr_item uil
                                                         ON(    uil.item = gtt.item
                                                            AND COALESCE(uil.user_attr_id,-1) = 41)
                                                  LEFT JOIN subs_item_dtl si
                                                         ON(    gtt.item = si.item
                                                            AND gtt.location = si.location),
                                                       item_location          ilc,
                                                       item_sups              isp
                                                  LEFT JOIN item_sup_location isc
                                                          ON(    isc.item = isp.item
                                                              AND isc.supplier = isp.item_supp
                                                              AND isc.primary_supp_ind = 'Y'
                                                              AND isc.primary_country_ind = 'Y')
                                                 WHERE ilc.item = gtt.item
                                                   AND ilc.location = gtt.location
                                                   AND ilc.status IN ('A', 'C', 'I')
                                                   AND isp.item = gtt.item
                                                   AND isp.primary_supp_ind = 'Y'
                                                   AND ilc.clearance_ind = COALESCE(%s, ilc.clearance_ind)
                                                 GROUP BY gtt.item,
                                                          gtt.location,
                                                          gtt.color_diff_id,
                                                          (CASE
                                                              WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                              ELSE 'N'
                                                           END))i
                                       WHERE (i.avail_qty + i.inactive_qty) >=COALESCE(%s, 1)
                                      AND (i.avail_qty + i.inactive_qty) <= COALESCE(%s, 999999999999);"

  Q_ins_style_itm_srch_dtl_tmp: " INSERT INTO alloc_itm_search_dtl_temp (sel_ind
                                                                        ,alloc_no
                                                                        ,alloc_criteria
                                                                        ,item
                                                                        ,item_desc
                                                                        ,diff_id
                                                                        ,loc
                                                                        ,hier1
                                                                        ,hier2
                                                                        ,hier3
                                                                        ,pack_ind
                                                                        ,inner_size
                                                                        ,case_size
                                                                        ,avail_qty
                                                                        ,inactive_qty
                                                                        ,holdback_qty
                                                                        ,holdback_type
                                                                        ,alloc_type
                                                                        ,size_prf_ind
                                                                        ,substitute_ind
                                                                        ,clearance_ind
                                                                        ,invent_ind
                                                                        ,split_ind
                                                                        ,som_type
                                                                        ,som_qty
                                                                        ,vpn
                                                                        ,season
                                                                        ,ref_1
                                                                        ,ref_2
                                                                        ,po_type
                                                                        ,err_ind
                                                                        ,err_message
                                                                        ,create_id
                                                                        ,create_datetime
                                                                        ,last_update_id
                                                                        ,last_update_datetime)
                                                                  SELECT 'N' sel_ind,
                                                                         %s  alloc_no,
                                                                         %s  alloc_criteria,
                                                                         item,
                                                                         item_desc,
                                                                         diff_id,
                                                                         loc,
                                                                         hier1,
                                                                         hier2,
                                                                         hier3,
                                                                         pack_ind,
                                                                         inner_size,
                                                                         case_size,
                                                                         avail_qty,
                                                                         inactive_qty,
                                                                         NULL     holdback_qty,
                                                                         NULL     holdback_type,
                                                                         %s       alloc_type,
                                                                         COALESCE((SELECT MAX('Y')
                                                                                      FROM alloc_size_profile sp
                                                                                     WHERE sp.item_parent = i.item
                                                                                       AND sp.aggr_diff_id = i.diff_id
                                                                                       AND sp.status = 'A'
                                                                                       AND curdate() <= sp.end_date
                                                                                       AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                                THEN curdate()
                                                                                                                                ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                                 END v_date) and curdate()
                                                                                       AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                        THEN curdate()
                                                                                                        ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                         END v_date) <= sp.create_datetime
                                                                                       LIMIT 1),'N') size_prf_ind,
                                                                         substitute_ind,
                                                                         clearance_ind,
                                                                         invent_ind,
                                                                         'N' split_ind,
                                                                         calc_multiple som_type,
                                                                         som_qty,
                                                                         UPPER(vpn) vpn,
                                                                         (SELECT user_attr_value_desc
                                                                            FROM user_attr
                                                                           WHERE user_attr_id    = 41
                                                                             AND user_attr_value = season_code
                                                                           LIMIT 1) season,
                                                                         NULL ref_1,
                                                                         NULL ref_2,
                                                                         NULL po_type,
                                                                         NULL err_ind,
                                                                         NULL err_message,
                                                                         USER() create_id,
                                                                         CURDATE() create_datetime,
                                                                         USER() last_update_id,
                                                                         CURRENT_TIMESTAMP() last_update_datetime
                                                                    FROM (SELECT gtt.rollup_item               item,
                                                                                 MAX(gtt.rollup_item_desc)     item_desc,
                                                                                 gtt.color_diff_id             diff_id,
                                                                                 gtt.location                  loc,
                                                                                 MAX(gtt.hier1)                hier1,
                                                                                 MAX(gtt.hier2)                hier2,
                                                                                 MAX(gtt.hier3)                hier3,
                                                                                 0                             holdback_qty,
                                                                                 NULL                          holdback_type,
                                                                                 SUM(GREATEST(COALESCE(GREATEST((CASE WHEN ilc.status in ('A','C') THEN ilc.item_soh ELSE 0 END), 0),0)
                                                                                      - (COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.reserved_qty ELSE 0 END, 0),0)
                                                                                      + COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.rtv_qty ELSE 0 END, 0),0)
                                                                                      + COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.non_sellable_qty ELSE 0 END, 0),0)
                                                                                      + COALESCE(GREATEST(CASE WHEN ilc.status in ('A','C') THEN ilc.cust_resv_qty ELSE 0 END, 0),0))
                                                                                      - (SELECT COALESCE(SUM(GREATEST(d.distro_qty,0)),0)
                                                                                          FROM alloc_sku_head h,
                                                                                              po_item_loc    ol,
                                                                                              po_dtl         oh,
                                                                                              alloc_dtl      d,
                                                                                              item_location  ilc1
                                                                                          WHERE h.item = gtt.item
                                                                                          AND h.wh = gtt.location
                                                                                          AND ilc1.location = gtt.location
                                                                                          AND ilc1.item = gtt.item
                                                                                          AND ilc1.status in ('A','C')
                                                                                          AND h.status IN ('A', 'R')
                                                                                          AND h.order_no IS NOT NULL
                                                                                          AND ol.po_no = h.order_no
                                                                                          AND ol.item = h.item
                                                                                          AND ol.location = h.wh
                                                                                          AND ol.received_qty > 0
                                                                                          AND oh.po_no = ol.po_no
                                                                                          AND oh.status IN ('A', 'C')
                                                                                          AND d.alloc_no = h.alloc_no
                                                                                          AND d.alloc_qty > 0
                                                                                          AND d.alloc_qty > COALESCE(d.tsf_qty, 0)),0)) avail_qty,
                                                                                 SUM(GREATEST(COALESCE((GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.item_soh ELSE 0 END), 0)),0)
                                                                                             - (GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.reserved_qty ELSE 0 END), 0)
                                                                                             + GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.rtv_qty ELSE 0 END), 0)
                                                                                             + GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.non_sellable_qty ELSE 0 END), 0)
                                                                                             + GREATEST((CASE WHEN ilc.status in ('I') THEN ilc.cust_resv_qty ELSE 0 END), 0))
                                                                                             - (SELECT COALESCE(SUM(GREATEST(d.distro_qty,0)),0)
                                                                                                  FROM alloc_sku_head h,
                                                                                                       po_item_loc    ol,
                                                                                                       po_dtl         oh,
                                                                                                       alloc_dtl      d,
                                                                                                       item_location  ilc1
                                                                                                 WHERE h.item = gtt.item
                                                                                                   AND h.wh = gtt.location
                                                                                                   AND ilc1.location = gtt.location
                                                                                                   AND ilc1.item = gtt.item
                                                                                                   AND ilc1.status in ('I')
                                                                                                   AND h.status IN ('A', 'R')
                                                                                                   AND h.order_no IS NOT NULL
                                                                                                   AND ol.po_no = h.order_no
                                                                                                   AND ol.item = h.item
                                                                                                   AND ol.location = h.wh
                                                                                                   AND ol.received_qty > 0
                                                                                                   AND oh.po_no = ol.po_no
                                                                                                   AND oh.status IN ('A', 'C')
                                                                                                   AND d.alloc_no = h.alloc_no
                                                                                                   AND d.alloc_qty > 0
                                                                                                   AND d.alloc_qty >COALESCE(d.tsf_qty, 0)),0)) inactive_qty,
                                                                                 MAX(CASE
                                                                                         WHEN si.item IS NOT NULL THEN 'Y'
                                                                                         ELSE 'N'
                                                                                      END)                      substitute_ind,
                                                                                 MAX(ilc.clearance_ind)         clearance_ind,
                                                                                 MAX(gtt.invent_ind)            invent_ind,
                                                                                 (CASE
                                                                                     WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                                                     ELSE 'N'
                                                                                  END)                         pack_ind,
                                                                                 MAX(isc.inner_pack_size)     inner_size,
                                                                                 MAX(isc.supp_pack_size)      case_size,
                                                                                 MAX(CASE
                                                                                         WHEN gtt.selling_uom = 'I' THEN 'I'
                                                                                         WHEN gtt.selling_uom = 'C' THEN 'C'
                                                                                         WHEN gtt.selling_uom = 'E' THEN 'E'
                                                                                         ELSE 'E'
                                                                                       END)                      calc_multiple,
                                                                                 MAX(CASE
                                                                                         WHEN gtt.selling_uom = 'I'
                                                                                         THEN
                                                                                             isc.inner_pack_size
                                                                                         WHEN gtt.selling_uom = 'C'
                                                                                         THEN
                                                                                             isc.supp_pack_size
                                                                                         ELSE
                                                                                             1
                                                                                       END)                    som_qty,
                                                                                 NULL                          capacity,
                                                                                 NULL                          facility,
                                                                                 NULL                          like_item_criteria,
                                                                                 MAX(isp.product_num)         vpn,
                                                                                 MAX(uil.user_attr_value) season_code
                                                                                 FROM alloc_items_srch_temp gtt
                                                                                 LEFT JOIN user_attr_item uil
                                                                                        ON(    uil.item = gtt.item
                                                                                           AND COALESCE(uil.user_attr_id,-1) = 41)
                                                                                 LEFT JOIN subs_item_dtl si
                                                                                        ON(    gtt.item = si.item
                                                                                           AND gtt.location = si.location),
                                                                                      item_location          ilc,
                                                                                      item_sups              isp
                                                                                 LEFT JOIN item_sup_location isc
                                                                                         ON(    isc.item = isp.item
                                                                                             AND isc.supplier = isp.item_supp
                                                                                             AND isc.primary_supp_ind = 'Y'
                                                                                             AND isc.primary_country_ind = 'Y')
                                                                                WHERE ilc.item = gtt.item
                                                                                  AND ilc.location = gtt.location
                                                                                  AND ilc.status IN ('A', 'C', 'I')
                                                                                  AND isp.item = gtt.item
                                                                                  AND isp.primary_supp_ind = 'Y'
                                                                                  AND ilc.clearance_ind = COALESCE(%s, ilc.clearance_ind)
                                                                                GROUP BY gtt.rollup_item,
                                                                                         gtt.location,
                                                                                         gtt.color_diff_id,
                                                                                         (CASE
                                                                                             WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                                                             ELSE 'N'
                                                                                          END))i
                                                                      WHERE (i.avail_qty + i.inactive_qty) >=COALESCE(%s, 1)
                                                                     AND (i.avail_qty + i.inactive_qty) <= COALESCE(%s, 999999999999); "
                                      
  Q_ins_itm_srch_dtl_whatif: "INSERT INTO alloc_itm_search_dtl_temp (sel_ind
                                                                     ,alloc_no
                                                                     ,alloc_criteria
                                                                     ,item
                                                                     ,item_desc
                                                                     ,diff_id
                                                                     ,loc
                                                                     ,hier1
                                                                     ,hier2
                                                                     ,hier3
                                                                     ,pack_ind
                                                                     ,inner_size
                                                                     ,case_size
                                                                     ,avail_qty
                                                                     ,inactive_qty
                                                                     ,holdback_qty
                                                                     ,holdback_type
                                                                     ,alloc_type
                                                                     ,size_prf_ind
                                                                     ,substitute_ind
                                                                     ,clearance_ind
                                                                     ,invent_ind
                                                                     ,split_ind
                                                                     ,som_type
                                                                     ,som_qty
                                                                     ,vpn
                                                                     ,season
                                                                     ,ref_1
                                                                     ,ref_2
                                                                     ,po_type
                                                                     ,err_ind
                                                                     ,err_message
                                                                     ,create_id
                                                                     ,create_datetime
                                                                     ,last_update_id
                                                                     ,last_update_datetime)
                                    SELECT 'N' sel_ind,
                                           %s  alloc_no,
                                           %s  alloc_criteria,
                                           item,
                                           item_desc,
                                           diff_id,
                                           loc,
                                           hier1,
                                           hier2,
                                           hier3,
                                           pack_ind,
                                           inner_size,
                                           case_size,
                                           avail_qty,
                                           inactive_qty,
                                           NULL     holdback_qty,
                                           NULL     holdback_type,
                                           %s       alloc_type,
                                           COALESCE((SELECT MAX('Y')
                                                       FROM alloc_size_profile sp
                                                      WHERE sp.item_parent = i.item
                                                        AND sp.aggr_diff_id = i.diff_id
                                                        AND sp.status = 'A'
                                                        AND curdate() <= sp.end_date
                                                        AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                 THEN curdate()
                                                                                                 ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                  END v_date) and curdate()
                                                        AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                         THEN curdate()
                                                                         ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                          END v_date) <= sp.create_datetime
                                                        LIMIT 1),'N') size_prf_ind,
                                           substitute_ind,
                                           clearance_ind,
                                           invent_ind,
                                           'N' split_ind,
                                           calc_multiple som_type,
                                           som_qty,
                                           UPPER(vpn) vpn,
                                           (SELECT user_attr_value_desc
                                              FROM user_attr
                                             WHERE user_attr_id    = 41
                                               AND user_attr_value = season_code
                                             LIMIT 1) season,
                                           NULL ref_1,
                                           NULL ref_2,
                                           NULL po_type,
                                           NULL err_ind,
                                           NULL err_message,
                                           USER() create_id,
                                           CURDATE() create_datetime,
                                           USER() last_update_id,
                                           CURRENT_TIMESTAMP() last_update_datetime
                                      FROM (SELECT DISTINCT gtt.item                      item,
                                                   (SELECT im.item_desc
                                                      FROM item_dtl im
                                                     WHERE im.item = gtt.item)   item_desc,
                                                   gtt.color_diff_id             diff_id,
                                                   /*gtt.location                loc,*/
                                                   100                           loc,
                                                   MAX(gtt.hier1)                hier1,
                                                   MAX(gtt.hier2)                hier2,
                                                   MAX(gtt.hier3)                hier3,
                                                   0                             holdback_qty,
                                                   NULL                          holdback_type,
                                                   NULL                          avail_qty,
                                                   NULL                          inactive_qty,
                                                   MAX(CASE
                                                           WHEN si.item IS NOT NULL THEN 'Y'
                                                           ELSE 'N'
                                                        END)                      substitute_ind,
                                                   MAX(ilc.clearance_ind)         clearance_ind,
                                                   MAX(gtt.invent_ind)            invent_ind,
                                                   (CASE
                                                       WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                       ELSE 'N'
                                                    END)                         pack_ind,
                                                   MAX(isc.inner_pack_size)     inner_size,
                                                   MAX(isc.supp_pack_size)      case_size,
                                                   MAX(CASE
                                                           WHEN gtt.selling_uom = 'I' THEN 'I'
                                                           WHEN gtt.selling_uom = 'C' THEN 'C'
                                                           WHEN gtt.selling_uom = 'E' THEN 'E'
                                                           ELSE 'E'
                                                         END)                      calc_multiple,
                                                   MAX(CASE
                                                           WHEN gtt.selling_uom = 'I'
                                                           THEN
                                                               isc.inner_pack_size
                                                           WHEN gtt.selling_uom = 'C'
                                                           THEN
                                                               isc.supp_pack_size
                                                           ELSE
                                                               1
                                                         END)                    som_qty,
                                                   NULL                          capacity,
                                                   NULL                          facility,
                                                   NULL                          like_item_criteria,
                                                   MAX(isp.product_num)          vpn,
                                                   MAX(uil.user_attr_value) season_code
                                                   FROM alloc_items_srch_temp gtt
                                                   LEFT JOIN user_attr_item uil
                                                          ON(    uil.item = gtt.item
                                                             AND COALESCE(uil.user_attr_id,-1) = 41)
                                                   LEFT JOIN subs_item_dtl si
                                                          ON(    gtt.item = si.item
                                                             AND gtt.location = si.location),
                                                        item_location          ilc,
                                                        item_sups              isp
                                                        LEFT JOIN item_sup_location isc
                                                               ON(    isc.item = isp.item
                                                                  AND isc.supplier = isp.item_supp
                                                                  AND isc.primary_supp_ind = 'Y'
                                                                  AND isc.primary_country_ind = 'Y')
                                                  WHERE ilc.item = gtt.item
                                                    AND ilc.location = gtt.location
                                                    AND ilc.status ='A'
                                                    AND isp.item = gtt.item
                                                    AND isp.primary_supp_ind = 'Y'
                                                    AND ilc.clearance_ind = COALESCE(%s, ilc.clearance_ind)
                                                  GROUP BY gtt.item,
                                                           gtt.location,
                                                           gtt.color_diff_id,
                                                           (CASE
                                                               WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                               ELSE 'N'
                                                            END))i
                                        WHERE NOT EXISTS(SELECT 1
                                                           FROM item_dtl id
                                                          WHERE id.item = i.item
                                                            AND orderable_ind = 'N');"

  Q_ins_style_itm_srch_dtl_wis: "INSERT INTO alloc_itm_search_dtl_temp (sel_ind
                                                                       ,alloc_no
                                                                       ,alloc_criteria
                                                                       ,item
                                                                       ,item_desc
                                                                       ,diff_id
                                                                       ,loc
                                                                       ,hier1
                                                                       ,hier2
                                                                       ,hier3
                                                                       ,pack_ind
                                                                       ,inner_size
                                                                       ,case_size
                                                                       ,avail_qty
                                                                       ,inactive_qty
                                                                       ,holdback_qty
                                                                       ,holdback_type
                                                                       ,alloc_type
                                                                       ,size_prf_ind
                                                                       ,substitute_ind
                                                                       ,clearance_ind
                                                                       ,invent_ind
                                                                       ,split_ind
                                                                       ,som_type
                                                                       ,som_qty
                                                                       ,vpn
                                                                       ,season
                                                                       ,ref_1
                                                                       ,ref_2
                                                                       ,po_type
                                                                       ,err_ind
                                                                       ,err_message
                                                                       ,create_id
                                                                       ,create_datetime
                                                                       ,last_update_id
                                                                       ,last_update_datetime)
                                                                 SELECT 'N' sel_ind,
                                                                        %s  alloc_no,
                                                                        %s  alloc_criteria,
                                                                        item,
                                                                        item_desc,
                                                                        diff_id,
                                                                        loc,
                                                                        hier1,
                                                                        hier2,
                                                                        hier3,
                                                                        pack_ind,
                                                                        inner_size,
                                                                        case_size,
                                                                        avail_qty,
                                                                        inactive_qty,
                                                                        NULL     holdback_qty,
                                                                        NULL     holdback_type,
                                                                        %s       alloc_type,
                                                                        COALESCE((SELECT MAX('Y')
                                                                                    FROM alloc_size_profile sp
                                                                                   WHERE sp.item_parent = i.item
                                                                                     AND sp.aggr_diff_id = i.diff_id
                                                                                     AND sp.status = 'A'
                                                                                     AND curdate() <= sp.end_date
                                                                                     AND sp.request_date BETWEEN (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                                              THEN curdate()
                                                                                                                              ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                                               END v_date) and curdate()
                                                                                     AND (SELECT CASE WHEN WEEKDAY(curdate()) = 0
                                                                                                      THEN curdate()
                                                                                                      ELSE DATE(curdate() - INTERVAL WEEKDAY(curdate()) DAY) - INTERVAL 1 DAY - INTERVAL 1*7 DAY
                                                                                                       END v_date) <= sp.create_datetime
                                                                                     LIMIT 1),'N') size_prf_ind,
                                                                        substitute_ind,
                                                                        clearance_ind,
                                                                        invent_ind,
                                                                        'N' split_ind,
                                                                        calc_multiple som_type,
                                                                        som_qty,
                                                                        UPPER(vpn) vpn,
                                                                        (SELECT user_attr_value_desc
                                                                           FROM user_attr
                                                                          WHERE user_attr_id    = 41
                                                                            AND user_attr_value = season_code
                                                                          LIMIT 1) season,
                                                                        NULL ref_1,
                                                                        NULL ref_2,
                                                                        NULL po_type,
                                                                        NULL err_ind,
                                                                        NULL err_message,
                                                                        USER() create_id,
                                                                        CURDATE() create_datetime,
                                                                        USER() last_update_id,
                                                                        CURRENT_TIMESTAMP() last_update_datetime
                                                                   FROM (SELECT DISTINCT gtt.rollup_item      item,
                                                                                MAX(gtt.rollup_item_desc)     item_desc,
                                                                                gtt.color_diff_id             diff_id,
                                                                                /*gtt.location                loc,*/
                                                                                100                             loc,
                                                                                MAX(gtt.hier1)                hier1,
                                                                                MAX(gtt.hier2)                hier2,
                                                                                MAX(gtt.hier3)                hier3,
                                                                                0                             holdback_qty,
                                                                                NULL                          holdback_type,
                                                                                NULL                          avail_qty,
                                                                                NULL                          inactive_qty,
                                                                                MAX(CASE
                                                                                        WHEN si.item IS NOT NULL THEN 'Y'
                                                                                        ELSE 'N'
                                                                                     END)                      substitute_ind,
                                                                                MAX(ilc.clearance_ind)         clearance_ind,
                                                                                MAX(gtt.invent_ind)            invent_ind,
                                                                                (CASE
                                                                                    WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                                                    ELSE 'N'
                                                                                 END)                         pack_ind,
                                                                                MAX(isc.inner_pack_size)     inner_size,
                                                                                MAX(isc.supp_pack_size)      case_size,
                                                                                MAX(CASE
                                                                                        WHEN gtt.selling_uom = 'I' THEN 'I'
                                                                                        WHEN gtt.selling_uom = 'C' THEN 'C'
                                                                                        WHEN gtt.selling_uom = 'E' THEN 'E'
                                                                                        ELSE 'E'
                                                                                      END)                      calc_multiple,
                                                                                MAX(CASE
                                                                                        WHEN gtt.selling_uom = 'I'
                                                                                        THEN
                                                                                            isc.inner_pack_size
                                                                                        WHEN gtt.selling_uom = 'C'
                                                                                        THEN
                                                                                            isc.supp_pack_size
                                                                                        ELSE
                                                                                            1
                                                                                      END)                    som_qty,
                                                                                NULL                          capacity,
                                                                                NULL                          facility,
                                                                                NULL                          like_item_criteria,
                                                                                MAX(isp.product_num)          vpn,
                                                                                MAX(uil.user_attr_value) season_code
                                                                                FROM alloc_items_srch_temp gtt
                                                                                LEFT JOIN user_attr_item uil
                                                                                       ON(    uil.item = gtt.item
                                                                                          AND COALESCE(uil.user_attr_id,-1) = 41)
                                                                                LEFT JOIN subs_item_dtl si
                                                                                       ON(    gtt.item = si.item
                                                                                          AND gtt.location = si.location),
                                                                                     item_location          ilc,
                                                                                     item_sups              isp
                                                                                     LEFT JOIN item_sup_location isc
                                                                                            ON(    isc.item = isp.item
                                                                                               AND isc.supplier = isp.item_supp
                                                                                               AND isc.primary_supp_ind = 'Y'
                                                                                               AND isc.primary_country_ind = 'Y')
                                                                               WHERE ilc.item = gtt.item
                                                                                 AND ilc.location = gtt.location
                                                                                 AND ilc.status ='A'
                                                                                 AND isp.item = gtt.item
                                                                                 AND isp.primary_supp_ind = 'Y'
                                                                                 AND ilc.clearance_ind = COALESCE(%s, ilc.clearance_ind)
                                                                               GROUP BY gtt.rollup_item,
                                                                                        gtt.location,
                                                                                        gtt.color_diff_id,
                                                                                        (CASE
                                                                                            WHEN gtt.rollup_type ='PACK' THEN 'Y'
                                                                                            ELSE 'N'
                                                                                         END))i
                                                                     WHERE NOT EXISTS(SELECT 1
                                                                                        FROM item_dtl id
                                                                                       WHERE id.item = i.item
                                                                                         AND orderable_ind = 'N');"

  Q_ins_itm_srch_dtl: "INSERT INTO alloc_itm_search_dtl(sel_ind
                                                       ,alloc_no
                                                       ,alloc_criteria
                                                       ,item
                                                       ,item_desc
                                                       ,diff_id
                                                       ,loc
                                                       ,hier1
                                                       ,hier2
                                                       ,hier3
                                                       ,pack_ind
                                                       ,inner_size
                                                       ,case_size
                                                       ,avail_qty
                                                       ,inactive_qty
                                                       ,holdback_qty
                                                       ,holdback_type
                                                       ,alloc_type
                                                       ,size_prf_ind
                                                       ,substitute_ind
                                                       ,clearance_ind
                                                       ,invent_ind
                                                       ,split_ind
                                                       ,som_type
                                                       ,som_qty
                                                       ,vpn
                                                       ,season
                                                       ,ref_1
                                                       ,ref_2
                                                       ,po_type
                                                       ,err_ind
                                                       ,err_message
                                                       ,create_id
                                                       ,create_datetime
                                                       ,last_update_id
                                                       ,last_update_datetime)
                                SELECT sel_ind
                                       ,alloc_no
                                       ,alloc_criteria
                                       ,item
                                       ,item_desc
                                       ,diff_id
                                       ,loc
                                       ,hier1
                                       ,hier2
                                       ,hier3
                                       ,pack_ind
                                       ,inner_size
                                       ,case_size
                                       ,avail_qty
                                       ,inactive_qty
                                       ,holdback_qty
                                       ,holdback_type
                                       ,alloc_type
                                       ,size_prf_ind
                                       ,substitute_ind
                                       ,clearance_ind
                                       ,invent_ind
                                       ,split_ind
                                       ,som_type
                                       ,som_qty
                                       ,vpn
                                       ,season
                                       ,ref_1
                                       ,ref_2
                                       ,po_type
                                       ,err_ind
                                       ,err_message
                                       ,create_id
                                       ,create_datetime
                                       ,last_update_id
                                       ,last_update_datetime
                                 FROM alloc_itm_search_dtl_temp tmp
                                WHERE alloc_no = %s
                                 AND NOT EXISTS(SELECT 1 
                                                   FROM alloc_itm_search_dtl sd
                                                  WHERE sd.alloc_no = tmp.alloc_no 
                                                    AND sd.item     = tmp.item
                                                    AND sd.loc      = tmp.loc
                                                    AND sd.sel_ind  = 'Y');"

  Q_fetch_items: "SELECT * FROM alloc_itm_search_dtl WHERE alloc_no = %s ORDER BY loc;"
  
  Q_del_item_srch_dtl: "DELETE FROM alloc_itm_search_dtl 
                              WHERE alloc_no = %s
                                AND sel_ind = 'N';"

  Q_del_item_srch_dtl_tmp: "DELETE FROM alloc_itm_search_dtl_temp 
                                  WHERE alloc_no = %s;"
  
  Q_del_non_pack_items: "DELETE FROM alloc_itm_search_dtl_temp 
                                WHERE alloc_no = %s
                                  AND pack_ind = 'N';"

add_pack_coverd_by_style:
  Q_create_srch_temp_1: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp_1 SELECT * FROM alloc_search_criteria_itm_temp;"

  Q_create_srch_temp_2: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp_2 SELECT * FROM alloc_search_criteria_itm_temp;"

  Q_merge_gtt: "INSERT INTO alloc_search_criteria_itm_temp (item, location, rollup_type, rollup_item, rollup_item_desc)
                                  SELECT i.pack_no, i.location, NULL, NULL, NULL
                                    FROM (SELECT gtt.location, pb2.pack_no, COUNT(DISTINCT im.item_parent) parent_cnt, MIN(DISTINCT im.item_parent) item_parent
		                                    FROM alloc_search_criteria_itm_temp_1 gtt,
                                                 packitem_breakout pb, 
                                                 packitem_breakout pb2, 
                                            	 item_dtl im, 
                                            	 item_dtl im2 
                                           WHERE im2.sellable_ind = 'N'
                                             AND pb.item = gtt.item
                                             AND pb.pack_no = pb2.pack_no
                                             AND pb2.item = im.item
                                             and pb.pack_no = im2.item
                                        GROUP BY gtt.location, pb2.pack_no) i, item_dtl im_parent 
                                           WHERE i.item_parent = im_parent.item 
                                             AND im_parent.item_aggregate_ind = 'Y'
                                             AND i.parent_cnt = 1 
                                             AND NOT EXISTS (SELECT 1
                                                               FROM alloc_search_criteria_itm_temp_2 target
                                                              WHERE target.location = i.location
                                                                AND target.item = i.pack_no );"

  Q_drop_criteria_temp_1: "DROP TEMPORARY TABLE alloc_search_criteria_itm_temp_1;"
  Q_drop_criteria_temp_2: "DROP TEMPORARY TABLE alloc_search_criteria_itm_temp_2;"

remove_multi_parent_packs:
  Q_create_srch_temp_1: "CREATE TEMPORARY TABLE IF NOT EXISTS alloc_search_criteria_itm_temp_1 SELECT * FROM alloc_search_criteria_itm_temp;"

  Q_delete_gtt: "DELETE FROM alloc_search_criteria_itm_temp
                                    WHERE (item, location) IN (SELECT i.item, i.location
                                      FROM (
                                        SELECT gtt.item, gtt.location, pack.sellable_ind, COUNT(DISTINCT COALESCE(im_parent.item, -999)) parent_cnt, MAX(COALESCE(im_parent.item_aggregate_ind, 'N')) agg_ind
                                        FROM alloc_search_criteria_itm_temp_1 gtt,
                                        packitem_breakout pb,
                                        item_dtl pack, 
                                        item_dtl comp 
                                        LEFT JOIN item_dtl im_parent ON comp.item_parent = im_parent.item
                                        where gtt.item = pb.pack_no
                                        and pb.pack_no = pack.item
                                        and pb.item = comp.item
                                        GROUP BY gtt.item, gtt.location, pack.sellable_ind ) i
                                      WHERE i.sellable_ind = 'N'
                                        AND i.agg_ind = 'Y'
                                        AND i.parent_cnt > 1 );"

  Q_drop_criteria_temp_1: "DROP TEMPORARY TABLE alloc_search_criteria_itm_temp_1;"